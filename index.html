
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>yann's Blog</title>
  <meta name="author" content="Yann Simon">

  
  <meta name="description" content="Edit: Update (May 25) I am learning Rust and, as a beginner, I have sometimes problems achieving some little tasks that would be so easy in other &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yanns.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="yann's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yanns.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2016/05/23/rust-closures-as-input-parameters/">Rust Closures as Input Parameters</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2016-05-23T21:47:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>Edit:</em> <a href="#update-2016-05-25"><em>Update (May 25)</em></a></p>

<p>I am learning <a href="https://www.rust-lang.org/">Rust</a> and, as a beginner, I have sometimes problems achieving some little tasks that would be so easy in other programming languages I know better.</p>

<p>But when I met some Rust developers and they ask me about my difficulties, I often forget about them.</p>

<p>I therefore decided to write about my difficulties in Rust to keep track of them.</p>

<p>So today about closures.</p>

<p>When reading a <a href="http://fredrik.anderzon.se/2016/05/10/rust-for-node-developers-part-1-introduction/">blog post introducing Rust for Node.js Developers</a> I made the same Todo application.</p>

<p>At the end, the program contains such piece of code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">remove_todo</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="o">=</span> <span class="n">todos</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">todo_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">todo</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">mark_done</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="o">=</span> <span class="n">todos</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">todo_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first function marks a Todo as deleted if it can be found by its ID in the vector.
The second function marks a Todo as completed, also if it can be found in the vector of Todos.</p>

<p>Some code is duplicated and I decided to refactor the common code in a third function, that would do <em>something</em> on a Todo if found in a vector.</p>

<p>This third function would take a closure as input parameter, like in pseudo-code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">closure</span> <span class="o">-</span> <span class="k">do</span> <span class="n">something</span> <span class="n">on</span> <span class="n">a</span> <span class="n">Todo</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="o">=</span> <span class="n">todos</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">todo_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">f</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>so that the 2 initial functions are simplified like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">remove_todo</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">mark_done</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This closure is a side-effect on a Todo. It should accept a mutable Todo as parameter and return nothing.</p>

<p>One <a href="http://rustbyexample.com/fn/closures/input_parameters.html">source of documentation for closures as input parameters</a> mentions that there exist 3 kinds of closures:</p>

<ul>
<li>Fn: takes captures by reference (<code>&amp;T</code>)</li>
<li>FnMut: takes captures by mutable reference (<code>&amp;mut T</code>)</li>
<li>FnOnce: takes captures by value (<code>T</code>)</li>
</ul>


<p>This is a lot of information for a new developer.</p>

<p>I tried different possibilities, like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">Todo</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="o">=</span> <span class="n">todos</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">todo_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">f</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">remove_todo</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">mark_done</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without any success:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cargo run
</span><span class='line'>   Compiling todo-list v0.1.0 <span class="o">(</span>file:///Users/yannsimon/projects/rust/rust-playground/todo-list<span class="o">)</span>
</span><span class='line'>src/main.rs:27:38: 27:50 error: the <span class="nb">type </span>of this value must be known in this context
</span><span class='line'>src/main.rs:27    with_todo_id<span class="o">(</span>todos, todo_id, <span class="p">|</span>todo<span class="p">|</span> todo.deleted <span class="o">=</span> <span class="nb">true</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>                                                      ^~~~~~~~~~~~
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="https://doc.rust-lang.org/book/closures.html#taking-closures-as-arguments">official documentation</a> was not so much help neither.</p>

<p>I asked for help on <a href="https://client00.chat.mibbit.com/?server=irc.mozilla.org&amp;channel=%23rust-beginners">#rust-beginners</a>.
People on this channel are <strong>very</strong> helpful and kind. The community of Rust is awesome!</p>

<p>I was proposed 2 solutions. Both work, and I choose that one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">with_todo_id</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="n">P</span><span class="p">)</span> <span class="n">where</span> <span class="n">P</span><span class="o">:</span> <span class="n">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">Todo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="o">=</span> <span class="n">todos</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">todo_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">f</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">remove_todo</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">mark_done</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compared to my previous attempt, the <code>f: &amp;Fn(&amp;mut Todo)</code> is replaced by <code>f: P where P: Fn(&amp;mut Todo)</code>.</p>

<p>I still do not completely understand why this works and not the previous version. I was explained Rust can use the reference to the closure&hellip; I will continue reading documentation about it&hellip;. ;)</p>

<p>If you have any good source for this, please <a href="https://twitter.com/simon_yann">tell me</a>.</p>

<p>In conclusion I still find closure as input parameters quite complex in Rust. I surely need to more understand the theory behind the language to fully understand them.</p>

<p>The Rust community is very helpful, but it may not scale if there are more and more beginners like me.</p>

<h4><a name="update-2016-05-25"></a> <a href="#update-2016-05-25"><em>Update (May 25)</em></a></h4>

<p>The following <a href="https://twitter.com/rustlang/status/734946700536774656">tweet</a> from <a href="https://twitter.com/rustlang">@rustlang</a> provided me the good keywords to search for:</p>

<blockquote><p>it's about trait objects vs type parameters, which can be tough when you're learning</p><footer><strong>@rustlang,</strong> <cite><a href='https://twitter.com/rustlang/status/734946700536774656'>twitter.com/rustlang/status/&hellip;</a></cite></footer></blockquote>


<p><a href="https://doc.rust-lang.org/book/trait-objects.html">Trait objects</a> are used for <a href="https://en.wikipedia.org/wiki/Dynamic_dispatch">dynamic dispatch</a>, feature found in most OO languages.</p>

<p>With that in mind, I could understand the <a href="https://doc.rust-lang.org/book/closures.html#taking-closures-as-arguments">Rust book about closures</a>.</p>

<p>If I use trait objects, this version works:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">Todo</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="o">=</span> <span class="n">todos</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">todo_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">f</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">remove_todo</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">&amp;|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">mark_done</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">&amp;|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trait objects force Rust to use dynamic dispatch.</p>

<p>If I use type parameter instead of a trait object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">with_todo_id</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="n">P</span><span class="p">)</span> <span class="n">where</span> <span class="n">P</span><span class="o">:</span> <span class="n">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">Todo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="o">=</span> <span class="n">todos</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">todo_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">f</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">remove_todo</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">mark_done</span><span class="p">(</span><span class="n">todos</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">todo_id</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">with_todo_id</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">,</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">=</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>then Rust is able to monomorphize the closure and use static dispatch, and does not need any object for the dyamic dispatch.</p>

<p>Another great example of the <a href="http://blog.rust-lang.org/2015/05/11/traits.html">zero-cost abstraction</a> possible with Rust!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2016/05/19/graphql-meetup-in-berlin/">Graphql Meetup in Berlin</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2016-05-19T20:49:15+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Honeypot organized the first meetup about <a href="http://graphql.org/">GraphQL</a> in Berlin and I had the pleasure to be invited to talk about my experience.</p>

<p>My topic was <a href="http://www.slideshare.net/yann_s/performance-optimisation-with-graphql">Performance optimisation with GraphQL</a>.</p>

<p>You can find the <a href="http://blog.honeypot.io/honeypot-tech-meetup-graphql/">slides for the other talks here</a>.</p>

<p><img src="/images/graphql-meetup-1.jpg"></p>

<p><img src="/images/graphql-meetup-2.jpg"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2016/04/26/migrate-a-playframework-app-from-2-dot-3-to-2-dot-5/">Migrate a Playframework App From 2.3 to 2.5</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2016-04-26T09:31:45+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I migrated several <a href="https://www.playframework.com/">play</a> applications from the version 2.3 to the version 2.5.</p>

<p>As this experience may interest other people, I decided to write about it.</p>

<p>So let&rsquo;s start!</p>

<h1><a href="#migrate-from-2.3-to-2.4">§</a> <a name="migrate-from-2.3-to-2.4"></a> Migration from 2.3 to 2.4</h1>

<p>First, we will migrate the application from the version 2.3 to the version 2.4.</p>

<p>For that, the <a href="https://www.playframework.com/documentation/latest/Migration24">migration guide</a> will be our reference.</p>

<p>How do I proceed?</p>

<h3><a href="#update-sbt-config">1.</a> <a name="update-sbt-config"></a> Update the sbt config to play 2.4</h3>

<p>First, I update the SBT configuration:</p>

<ul>
<li>update the play version in <code>project/plugins.sbt</code>:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-addSbtPlugin("com.typesafe.play" % "sbt-plugin" % "2.3.10")
</span><span class='line'>+addSbtPlugin("com.typesafe.play" % "sbt-plugin" % "2.4.6")</span></code></pre></td></tr></table></div></figure>


<ul>
<li>if needed, update the sbt version in <code>project/build.properties</code>:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sbt.version=0.13.11</span></code></pre></td></tr></table></div></figure>


<ul>
<li>update the <code>build.sbt</code>:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-import PlayKeys._
</span><span class='line'>+import play.sbt.PlayImport._</span></code></pre></td></tr></table></div></figure>


<p>I also had to replace <code>playVersion.value</code> with <code>play.core.PlayVersion.current</code>.</p>

<p>The goal of this first step is to be able to load the application with <code>sbt</code>, even if the application itself does not compile. At this point, Intellij can load the application with a play 2.4 version, and can provide auto-completion.</p>

<h3><a href="#fix-compilation">2.</a> <a name="fix-compilation"></a> Fix compilation errors</h3>

<p>Then, I fix the compilation</p>

<p>Inside sbt, I just trigger the compilation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~compile</span></code></pre></td></tr></table></div></figure>


<p>and fix all compilation errors. The play team has made a very good job at documenting all steps in the <a href="https://www.playframework.com/documentation/latest/Migration24">migration guide</a>.</p>

<p>At this point, I just want the application to compile with the minimal number of changes. I do not care if I use deprecated APIs.</p>

<h3><a href="#run-application">3.</a> <a name="run-application"></a> Run the application</h3>

<p>When all compilation errors are fixed, I just make sure that the application can run:</p>

<p>In sbt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~run</span></code></pre></td></tr></table></div></figure>


<p>When running the application, I sometimes discovered version conflicts between libs (ex: Netty versions) and I know if I can complete the migration or if I have to update a dependency before.</p>

<p>Analysing all dependencies can be difficult.
I use the <a href="https://github.com/jrudolph/sbt-dependency-graph">sbt-dependency-graph</a> to have an overview of all dependencies and find overriding versions.</p>

<h3><a href="#fix-tests">4.</a> <a name="fix-tests"></a> Fix the tests</h3>

<p>Then I fix all compilation errors in the tests, and then check that the tests are successful.</p>

<p>In sbt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~testQuick</span></code></pre></td></tr></table></div></figure>


<p>When all the tests are green, the application is migrated.
The migration to play 2.4 is now completed, profit from the new version! ;)</p>

<h3><a href="#remove-deprecated-usages">5.</a> <a name="remove-deprecated-usages"></a> Remove all usages of deprecated API</h3>

<p>Now it is time to clean our application and to fix all code using a deprecated API.</p>

<p>This clean up can be done step by step.</p>

<p>I use the Scala API, and I prefer not to use any runtime dependency injection framework.</p>

<p>I introduced the so-called <a href="https://www.playframework.com/documentation/2.5.x/ScalaCompileTimeDependencyInjection"><em>compile time dependency injection</em></a> to simply instantiate my controllers in one application loader.</p>

<p>For more info about this topic, please refer to:</p>

<ul>
<li><a href="http://de.slideshare.net/yann_s/play-24dimacwire">my talk about it</a> at the <a href="/blog/2015/05/20/di-with-play-2-dot-4/">play meetup</a></li>
<li><a href="http://loicdescotte.github.io/posts/play24-compile-time-di/">this great post from Loïc Descotte</a></li>
</ul>


<p>This cleanup is necessary before updating to play 2.5, as deprecated API are likely to be removed in the next version.</p>

<h1><a href="#migrate-from-2.4-to-2.5">§</a> <a name="migrate-from-2.4-to-2.5"></a> Migration from 2.4 to 2.5</h1>

<p>For that, the <a href="https://www.playframework.com/documentation/latest/Migration25">migration guide</a> will be our reference.</p>

<p>The migrate follow the same steps as <a href="/#migrate-from-2.3-to-2.4">the previous migration</a>:</p>

<ul>
<li><a href="#update-sbt-config">update the sbt config</a>, but to play 2.5:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-addSbtPlugin("com.typesafe.play" % "sbt-plugin" % "2.4.6")
</span><span class='line'>+addSbtPlugin("com.typesafe.play" % "sbt-plugin" % "2.5.2")</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="#fix-compilation">fix the compilation errors</a>, like in application loader:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-    Logger.configure(context.environment)
</span><span class='line'>+    LoggerConfigurator(context.environment.classLoader).foreach { _.configure(context.environment) }</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="#run-application">run the application</a></li>
<li><a href="#fix-tests">fix the tests</a></li>
<li><a href="#remove-deprecated-usages">clean up the application</a><br>
For example, I can remove the <code>InjectedRoutesGenerator</code> as it is now the default.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-routesGenerator := InjectedRoutesGenerator</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2016/02/10/trampoline-execution-context-with-scala-futures/">Trampoline Execution Context With Scala Futures</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2016-02-10T21:19:33+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Disclaimer: I am continually learning, and this post reflects my current understanding of the topic. I may be wrong. Do not believe directly what I write. Test what you need. If you want to provide some precisions or corrections, please contact me on <a href="https://twitter.com/simon_yann">twitter</a>, and I&rsquo;ll fix this post.</p>

<p><a href="https://twitter.com/runarorama">Rúnar</a> showed in a <a href="http://blog.higher-order.com/blog/2015/06/18/easy-performance-wins-with-scalaz/">blog post how Scalaz Tasks can perform better than the Scala Futures</a>.</p>

<p>He explains the details very well. If you have not read that post, I recommend it highly.</p>

<p>The main point if that Scala <code>Future</code> adds a context switching for each <code>map</code> or <code>flatMap</code>.
With Scalaz <code>Task</code>, we have to describe which tasks need a new thread, the other ones are called on the same thread as the previous computation, avoiding these context switchings.</p>

<p>With Scala Futures, if you want to multiply the result of a <code>Future[Int]</code> by 2, you need an <code>ExecutionContext</code> (EC):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.global</span>
</span><span class='line'><span class="k">val</span> <span class="n">futureCount</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="n">futureCountOfUsers</span><span class="o">()</span>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">futureCount</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)(</span><span class="n">global</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>or with an implicit resolution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'><span class="k">val</span> <span class="n">futureCount</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="n">futureCountOfUsers</span><span class="o">()</span>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">futureCount</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To compute the <code>i =&gt; i * 2</code>, the ExecutionContext may use a different thread than the one having the result of the <code>futureCountOfUsers</code>. We observe a context switching between the future and the callback in the <code>map</code>. And the thread executing <code>i =&gt; i * 2</code> can run on a different CPU/core than the one having the result of <code>futureCount</code>, meaning that the CPU cache is missed.</p>

<p>This overhead is not problematic for simple computations. But if we do 100 or 1000 of them, then it can have a significant impact on performances.</p>

<p>And in my opinion, Scala Futures have other downsides.</p>

<p>For example, with the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">value1</span> <span class="k">&lt;-</span> <span class="n">functionThatReturnsFutureValue1</span>
</span><span class='line'>  <span class="n">value2</span> <span class="k">&lt;-</span> <span class="n">functionThatReturnsFutureValue2</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">value1</span><span class="o">,</span> <span class="n">value2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>functionThatReturnsFutureValue1</code> and <code>functionThatReturnsFutureValue2</code> runs sequentially, even if there is no dependency between the two.</p>

<p>On the other hand:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">futureValue1</span> <span class="k">=</span> <span class="n">functionThatReturnsFutureValue1</span>
</span><span class='line'><span class="k">val</span> <span class="n">futureValue2</span> <span class="k">=</span> <span class="n">functionThatReturnsFutureValue2</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">value1</span> <span class="k">&lt;-</span> <span class="n">futureValue1</span>
</span><span class='line'>  <span class="n">value2</span> <span class="k">&lt;-</span> <span class="n">futureValue2</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">value1</span><span class="o">,</span> <span class="n">value2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>computes <code>functionThatReturnsFutureValue1</code> and <code>functionThatReturnsFutureValue2</code> in parallel.</p>

<p>It means that Scala Futures do not respect the principe of <a href="https://en.wikipedia.org/wiki/Referential_transparency">&ldquo;referential transparency&rdquo;</a>.
It&rsquo;s not only a theoretical problem, new users of Scala Futures often have problems with that.</p>

<p>And what I do not like about Scala Future is that we always need an ExecutionContext, even for small non-blocking computations.</p>

<p>For example, instead of writing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">multiplyBy2</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">f</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need either to import a ExecutionContext that is always used, or leave the liberty to the caller of the function and write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">multiplyBy2</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">f</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>My first impression with Scalaz Tasks is that they have a better design than the Scala Futures.
But I have not used Scalaz Tasks extensively and cannot say if they have other problems.</p>

<p>But all in all, Scala Futures are here to stay. They are part of the standard API and are used everywhere.</p>

<p>I&rsquo;m still wondering why the Scala Futures were designed that way.
I can only guess, but I think this avoids some common pitfalls:</p>

<ul>
<li>&ldquo;easy&rdquo; for new-comers: simply import the default execution context and that’s all</li>
<li>safe by default: If a callback takes a long time (blocking IO and expensive computation), this callback will not block other ones. The execution context will be able to use a different thread for other computations.</li>
<li>and a design like Scala Tasks works well if all parts of the system are non-blocking and using one thread pool. The reality is more complex. Each driver/http client can use its own thread pool. For example, an asynchronous http client may have its own thread pool because some parts of the networking API in Java is blocking like the standard ns lookup <code>InetAddress.getByName()</code>. Running a computation directly on the thread without forking it will run the computation of the thread pool of the http client. And that can lead to an exhaustion of the thread pool of the http client, and the http client cannot function anymore.</li>
</ul>


<h3>Introducing the trampoline execution context</h3>

<p>This performance problem with the standard execution context is not new. The play framework team had this problem, especially with Iteratees that compute everything with a Future and uses callbacks extensively on stream of data.
To solve this problem, James Roper introduced the <a href="https://github.com/playframework/playframework/blob/master/framework/src/iteratees/src/main/scala/play/api/libs/iteratee/Execution.scala#L31-L128">trampoline Execution Context</a>.
This trampoline execution context is a great piece of software:</p>

<ul>
<li>it makes sure the callbacks are run on the same thread than the future to avoid context switchings.</li>
<li>it does not overflow with recursive callbacks.</li>
</ul>


<p>To show the benefit of the trampoline execution context, let&rsquo;s call this function that does not make any sense, but simply calls <code>Future.map</code> n times:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">range</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="mi">0</span> <span class="n">to</span> <span class="n">n</span><span class="o">).</span><span class="n">foldLeft</span><span class="o">[</span><span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">f</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With n = 5 000 000:</p>

<ul>
<li>Scala Futures with standard EC: 0.037 ops/s</li>
<li>Scala Futures with trampoline EC: 1.397 ops/s</li>
</ul>


<h3>Should we use the trampoline EC?</h3>

<p>When we are confident with execution contexts, I thing we can use this trampoline EC if:</p>

<ul>
<li>the callback is running very fast. For example:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">multiplyBy2</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">f</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)(</span><span class="n">trampolineEC</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>we never call some blocking IO. This point can be tricky: some scala libs can use some java libs that use InputStream or OutputStream that can block.</li>
</ul>


<p>If you are unsure, use the standard EC.</p>

<p>If you want to try this yourself, the <a href="https://github.com/yanns/trampoline-EC">code is on github</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/12/07/review-of-essential-slick/">Review of Essential Slick (for Slick 3.0)</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-12-07T18:00:36+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had the pleasure to review the book &ldquo;<a href="http://underscore.io/books/essential-slick/">Essential Slick</a>&rdquo; about <a href="http://slick.typesafe.com/">Slick 3</a>.</p>

<p>I really enjoyed reading it. For anyone starting a project with Slick, I highly recommend this book, in particular to learn about:</p>

<ul>
<li>how to build queries that can be composed and re-used</li>
<li>how to structure the code</li>
<li>the patterns, anti-patterns and pitfalls to avoid.</li>
</ul>


<p>The book goes over a lot of concepts, from simple queries and data-modeling to views, projections, joins and aggregates.</p>

<p>Slick 3 has very powerful concepts that could be hard to manage. The book tries to teach us how to use them.</p>

<p>Some chapters are more demanding, for instance the 2nd chapter introduces in only a few pages concepts like Queries, Actions, Effects, Streaming.</p>

<p>But once the step managed, I had the feeling to have the good abstractions in my mind to build an application based on Slick. And I could use these concepts to solve the exercises.</p>

<p>What I really liked:</p>

<ul>
<li>exercices: I think I can only learn a library when I use it and the exercises in the book are a very good opportunity to practice.</li>
<li>the sbt console is so configured that I could copy/paste all examples from the book into the console and play with them.</li>
<li>focus on composability and re-usability</li>
<li>the book also points out when one abstraction is not optimal for a particular problem and proposes some alternatives.</li>
</ul>


<p>What I missed:</p>

<ul>
<li>the 3.0 version of Slick is a lot about asynchronity, streaming and I wish the book could dig further in these concepts.</li>
</ul>


<p>All in all, a very good book!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/11/17/introduction-to-type-classes-in-scala/">Play Framework Meetup in Berlin in November 2015</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-11-17T21:43:55+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>During the <a href="http://www.meetup.com/Play-Berlin-Brandenburg/events/226561633/">play framework meetup in Berlin in November 2015</a>:</p>

<h2>for a better workflow between designers and developers</h2>

<p><a href="https://twitter.com/lluizesc">Laura</a> made a very good talk about how to better organize the work between front-end designers and developers.</p>

<p>For that, her team build some tools:</p>

<ul>
<li><p>the designer uses an assets pipeline in nodejs to build a website. The templates are written with <a href="http://handlebarsjs.com/">handlebars</a>. When the website is ready, a release is made and all assets are packaged as a <a href="http://www.webjars.org/">webjar</a>: <a href="https://github.com/lauraluiz/handlebars-webjars-demo">https://github.com/lauraluiz/handlebars-webjars-demo</a></p></li>
<li><p>the developer uses a play framework application that is capable of using directly the assets released by the designer: <a href="https://github.com/lauraluiz/play-handlebars-demo">https://github.com/lauraluiz/play-handlebars-demo</a></p></li>
</ul>


<p>Slides: <a href="http://slides.com/lauraluiz/handlebarsplay">http://slides.com/lauraluiz/handlebarsplay</a></p>

<p>Project using this workflow: <a href="https://github.com/sphereio/sphere-sunrise">https://github.com/sphereio/sphere-sunrise</a></p>

<h2>type classes in Scala</h2>

<p>I introduced type classes in Scala: <a href="http://www.slideshare.net/yann_s/introduction-to-type-classes-in-scala">http://www.slideshare.net/yann_s/introduction-to-type-classes-in-scala</a></p>

<p>Step by step, I explained how the Json Reads/Writes/Formats work in the <a href="https://www.playframework.com/documentation/2.4.x/ScalaJson">scala API of the play framework</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/05/20/di-with-play-2-dot-4/">DI With Play 2.4</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-05-20T23:01:57+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>During the <a href="http://www.meetup.com/Play-Berlin-Brandenburg/events/222130013/">play framework meetup in Mai 2015</a>, there were 3 talks about Dependency Injection (DI) in Play 2.4:</p>

<ul>
<li><p>from Micheal: runtime DI in Java with <a href="https://github.com/google/guice">Guice</a>, the default framework introduced in play 2.4: <a href="https://github.com/schleichardt/play-2-4-di-talk">https://github.com/schleichardt/play-2-4-di-talk</a></p></li>
<li><p>from <a href="https://twitter.com/easyangel">Oleg</a>: runtime DI in Scala with <a href="http://scaldi.org/">Scaldi</a>: <a href="http://scaldi.github.io/scaldi-play-2.4.0-presentation/">http://scaldi.github.io/scaldi-play-2.4.0-presentation/</a></p></li>
<li><p>compile-time DI in Scala with constructor arguments or <a href="https://github.com/adamw/macwire">MacWire</a>: <a href="http://de.slideshare.net/yann_s/play-24dimacwire">http://de.slideshare.net/yann_s/play-24dimacwire</a>. For that talk, I re-used the TBA application I used at the <a href="/blog/2014/02/17/ping-conf-2014/">Ping Conf</a> last year and added a version using MacWire: <a href="https://github.com/yanns/TPA/tree/master/frontend/TBA_macwire">https://github.com/yanns/TPA/tree/master/frontend/TBA_macwire</a></p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/11/10/goto-conference-2014/">Goto Conference 2014</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-11-10T10:33:59+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My notes from the <a href="http://gotocon.com/berlin-2014">goto conference Berlin 2014</a>:</p>

<h2>Thursday</h2>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Opening%20Keynote:%20Software%20Design%20in%20the%2021st%20Century">Opening Keynote: Software Design in the 21st Century</a> - <a href="https://twitter.com/martinfowler">Martin Fowler</a></h5>

<p>We, developers, take responsibility in the code we write.<br/>
We cannot simply say: &ldquo;I implemented that because I was told so&rdquo;.<br/>
Avoid <a href="http://darkpatterns.org/">dark patterns</a>.</p>

<p>We are not code monkeys.</p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Aeron:%20The%20Next%20Generation%20in%20Open-Source%20High-Performance%20Messaging">Aeron: The Next Generation in Open-Source High-Performance Messaging</a> - <a href="https://twitter.com/mjpt777">Martin Thompson</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/MartinThompson_AeronTheNextGenerationInOpenSourceHighPerformanceMessaging.pdf">slides</a>
<a href="http://mechanical-sympathy.blogspot.com/">blog</a></p>

<p><a href="https://github.com/real-logic/Aeron">Aeron</a> is a OSI layer 4 Transport for message oriented streams.
is simply impressive, achieving a very low latency.<br/>
I&rsquo;d like to see an integration of Aeron in Akka cluster.</p>

<p><a href="https://www.youtube.com/watch?v=tM4YskS94b0">similar talk</a></p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Writing%20highly%20Concurrent%20Polyglot%20Applications%20with%20Vert.x">Writing highly Concurrent Polyglot Applications with Vert.x</a> - <a href="https://twitter.com/timfox">Tim Fox</a></h5>

<p>It was a good introduction to Vert.x.<br/>
But I was expecting more than an introduction.</p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Fast%20Analytics%20on%20Big%20Data">Fast Analytics on Big Data</a> - Petr Maj and Tomas Nykodym</h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/PetrMaj_and_TomasNykodym_FastAnalyticsOnBigData.pdf">slides</a></p>

<p>Presentation of an ML runtime for bigdata.</p>

<p><a href="https://github.com/0xdata/h2o">Code</a> <a href="https://github.com/0xdata/h2o-dev">With Spark API</a></p>

<p>TODO: have a look at <a href="https://github.com/0xdata/h2o-training">https://github.com/0xdata/h2o-training</a></p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Security%20Architecture%20for%20the%20SmartHome">Security Architecture for the SmartHome</a> - <a href="https://twitter.com/jacobfahrenkrug">Jacob Fahrenkrug</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/JacobFahrenkrug_SecurityArchitectureForTheSmartHome.pdf">slides</a></p>

<p>A good presentation about the future threats of connected objects and the solution <a href="http://www.yetu.com/">yetu</a> implements.</p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Graph%20All%20The%20Things!!%20Graph%20Database%20Use%20Cases%20That%20Aren't%20Social">Graph All The Things!! Graph Database Use Cases That Aren&rsquo;t Social</a> - <a href="https://twitter.com/emileifrem">Emil Eifrem</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/EmilEifrem_GraphAllTheThingsGraphDatabaseUseCasesThatArentSocial.pdf">slides</a></p>

<p>very good presentation of <a href="http://neo4j.com/">Neo4j</a>.<br/>
We should use a graph database where it make sense - the search queries are much easier to write / read, and the performance very good.</p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Party%20Keynote:%20Staying%20Ahead%20of%20the%20Curve">Party Keynote: Staying Ahead of the Curve</a> - <a href="https://twitter.com/trisha_gee">Trisha Gee</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/TrishaGee_PartyKeynoteStayingAheadOfTheCurve.pdf">slides</a></p>

<h2>Friday</h2>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Morning%20Keynote:%20Excellence%20Culture%20&amp;%20Humane%20Keeping%20of%20Techies">Morning Keynote: Excellence Culture &amp; Humane Keeping of Techies</a> - <a href="https://twitter.com/wilddueck">Prof. Dr. Gunter Dueck</a></h5>

<p>a very good keynote, very funny and true at the same time.</p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Aerospike:%20Flash-optimized,%20High-Performance%20noSQL%20database%20for%20All">Aerospike: Flash-optimized, High-Performance noSQL database for All</a> - <a href="https://twitter.com/khaf">Khosrow Afroozeh</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/KhosrowAfroozeh_AerospikeFlashOptimizedHighPerformanceNoSQLDatabaseForAll.pdf">slides</a></p>

<p>A new database on my radar - impressive.</p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/Docker%20-%20A%20Lot%20Changed%20in%20a%20Year">Docker - A Lot Changed in a Year</a> - <a href="http://twitter.com/cpswan">Chris Swan</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/ChrisSwan_DockerALotChangedInAYear.pdf">slides</a></p>

<p>Docker is maturating.<br/>
Just do not forget that &ldquo;containers do not contain&rdquo; -> no complete security between container and host, and between containers.</p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/The%20Joys%20and%20Perils%20of%20Interactive%20Development">The Joys and Perils of Interactive Development</a> - <a href="https://twitter.com/stuartsierra">Stuart Sierra</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/protected/StuartSierra_TheJoysAndPerilsOfInteractiveDevelopment.pdf">slides</a></p>

<h5><a href="http://gotocon.com/berlin-2014/presentation/New%20Concurrency%20Utilities%20in%20Java%208">New Concurrency Utilities in Java 8</a> - <a href="https://twitter.com/AngelikaLanger">Angelika Langer</a></h5>

<p><a href="http://gotocon.com/dl/goto-berlin-2014/slides/protected/AngelikaLanger_NewConcurrencyUtilitiesInJava8.pdf">slides</a></p>

<ul>
<li>Future API is becoming usable, it is now possible to chain futures and callbacks.</li>
<li>new StampedLock is optimized for reading. (personal note: but lock-free algorithms should be preferred, like in <a href="http://mechanical-sympathy.blogspot.com/">Lock-Based vs Lock-Free Concurrent Algorithms</a>)</li>
</ul>


<h5><a href="http://gotocon.com/berlin-2014/presentation/Adaptive%20Planning%20-%20Beyond%20User%20Stories">Adaptive Planning - Beyond User Stories</a> - <a href="https://twitter.com/gojkoadzic">Gojko Adzic</a></h5>

<p><a href="http://gojko.net/">blog</a>
<a href="http://gotocon.com/dl/goto-berlin-2014/slides/GojkoAdzic_AdaptivePlanningBeyondUserStories.pdf">slides</a></p>

<p>Gojko Adzic really thinks agile. Good presentation of how to make better user stories.<br/>
Do not describe a desired behavior but a behavior change.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/08/10/complete-asynchronous-io-for-play-applications-in-servlet-3-dot-1-containers-with-the-play2-war-plugin/">Asynchronous IO for Play! Applications in Servlet 3.1 Containers With the Play2-war Plugin</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-08-10T18:55:36+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A <a href="http://playframework.com/">Play application</a> does not need any container and <a href="http://playframework.com/documentation/2.3.x/Production">runs directly in production</a>.</p>

<p>However some organizations prefer to run play applications within a servlet container and can use for this the <a href="https://github.com/play2war/play2-war-plugin">WAR Plugin</a>.</p>

<p>I am very pleased to share that this plugin is now compatible with servlet 3.1 containers. It can now use the new asynchronous IO possibilities.</p>

<p>Let me explain why and when it is important.</p>

<h3>Play applications are asynchronous</h3>

<p>The Play Framework is build to be totally asynchronous and reactive. It uses no blocking IO. A Play application scales very well, using very few threads.</p>

<p>This reactive consuming or construction of IO stream is designed in play with <a href="http://www.playframework.com/documentation/2.3.x/Iteratees">Iteratees</a>. It will progressively be completed with <a href="http://typesafe.com/blog/typesafe-announces-akka-streams">Akka Streams</a>, the implementation in Akka of the reactive stream project (<a href="http://www.reactive-streams.org/">http://www.reactive-streams.org/</a>)</p>

<h3>Servlet containers use blocking IO</h3>

<p>On the other hand, servlet containers traditionally use a <a href="http://www.slideshare.net/brikis98/the-play-framework-at-linkedin/62">thread per request</a>. When doing IO (database access, external web request), the thread waits for the IO completion (blocking IO). That&rsquo;s why servlet containers need a lot of working threads to handle requests in parallel (<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/executor.html">default 200 threads max for tomcat</a>)</p>

<h4>Asynchronous 3.0 servlet</h4>

<p>Servlet 3.0 containers introduced the possibility to “suspend” a request.
For example, if an application makes an HTTP request to another web service using the <a href="http://www.playframework.com/documentation/2.3.x/ScalaWS">WS client</a>, the play2 war plugin is able to suspend the servlet request until the external web service answers. It means that with the same number of servlet threads, a servlet 3.0 container can support more requests in parallel than a servlet 2.x container. It does not need that a thread waits for an HTTP request, this thread can be used for other requests.</p>

<h4>Limitations of asynchronous 3.0 servlet</h4>

<p>When uploading or downloading a big file, the servlet container is able to stream the data. But between each chunks, the servlet thread is blocking, waiting for the next one.
It is not possible to consume one chunk, and later, when we are ready to consume another one, tell the container: “now I am ready, you can send me the next chunk as soon as you receive one from the browser”.</p>

<p>If a browser needs an hour to upload a file with a slow Internet connection, the container needs a thread during an hour, even if the application does not do anything, just waiting for the upload completion.</p>

<h3>Play applications deployed as war are limited by the servlet container</h3>

<p>A Play application deployed in a war container is limited by the technical possibilites of the servlet API. With a servlet 2.x or 3.0, a Play application does not scale as well as when run natively.</p>

<h3>New asynchronous IO in servlet 3.1</h3>

<p>The <a href="https://jcp.org/en/jsr/detail?id=340">servlet 3.1 specification</a> added asynchronous IO. Based on <a href="http://docs.oracle.com/javase/7/docs/api/java/util/EventListener.html">events</a>, it is now possible to completly handle an <a href="https://javaee-spec.java.net/nonav/javadocs/javax/servlet/ReadListener.html">upload</a> and a <a href="https://javaee-spec.java.net/nonav/javadocs/javax/servlet/WriteListener.html">download</a> asynchronously.</p>

<h3>Asynchronous IO in WAR Plugin for Play! applications</h3>

<p>Since the <a href="https://github.com/play2war/play2-war-plugin/releases/tag/1.2">version 1.2</a>, the play2 war plugin is using this API to provide a complete reactive upload and download.</p>

<p>To use this, simply <a href="https://github.com/play2war/play2-war-plugin/wiki/Configuration#servlet-31-container-configuration">configure the servlet container version</a> and deploy to a servlet 3.1 server.</p>

<h4>When to use this feature?</h4>

<p>This feature should be used especially if the application is using big download/upload. The servlet 3.1 will help to scale much better.</p>

<p>During my tests, I could upload and download files from several GB in parallel. The container and the JVM garbage collection could support that without any problems. The memory usage was very low.</p>

<p>Also please test this new version and report issues!</p>

<h4>How to build the application to scale better?</h4>

<p>To scale as much as possible, the application should not block. It should always use asynchronous IO API like in the WS client.</p>

<p>But in the Java World a lot a librairies are still designed for a one-thread-per-request model and do not provide asynchronous API. It is for example the case for a JDBC driver. In that case, a separate dispatcher should be configured to handle blocking IO. More Information for this can be found in the <a href="http://www.playframework.com/documentation/2.3.x/ThreadPools">Play Framework documentation</a>.</p>

<h3>Implementation history</h3>

<p>The implementation of asynchronous IO in the WAR plugin lasted a few months.
The <a href="https://github.com/play2war/play2-war-plugin/pull/204">first pull request</a> introduced the asynchronous download, and <a href="https://github.com/play2war/play2-war-plugin/pull/235">the second one</a> the asynchronous upload.
I&rsquo;d like to thank <a href="https://twitter.com/jroper">James Roper</a> and <a href="https://twitter.com/viktorklang">Viktor Klang</a> for their reviews.</p>

<p>This feature was quite challenging to implement:</p>

<ul>
<li><p>I had to find a good way to implement the glue between two very different APIs. The servlet 3.1 API is quite imperative and use <a href="http://docs.oracle.com/javase/7/docs/api/java/util/EventListener.html">EventListener</a> and methods with side effects. The Iteratee API is functional and I needed some time to feel at ease with it.</p></li>
<li><p>The servlet 3.1 specification was recently finalized as I began. The first implementations in some containers contained bugs. Reporting the problems, explaining, convincing other developers took a lot of time and energy.</p></li>
<li><p>The servlet 3.1 specification is not always explicit. The implementations in the different servlet containers are also different. Finding an implementation that covers all these subtle differences was challenging. The <a href="https://play-war.ci.cloudbees.com/job/Play_2_War_Run_integration_tests_-_Play_22x/">testing infrastructure of the play2-war plugin</a> provides a lot of integration tests with different containers and helped a lot for this.</p></li>
</ul>


<p>My firm <a href="http://www.leanovate.de/">Leanovate</a> gave me some time to work on that. Having worked two days full time on it helped me a lot. Thanks Leanovate for this!</p>

<p>All in all it was a great experience to contribute to the WAR Plugin, and I hope my work will be useful for others.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/05/30/enlarge-your-test-scope/">Enlarge Your Test Scope</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-05-30T22:00:22+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At the beginning at the year, I had the chance to present <a href="blog/2014/02/17/ping-conf-2014/">how to organize a play application with the Cake pattern</a> at <a href="http://www.ping-conf.com/">Ping Conf</a>.
I showed how this pattern enable designing the application as components, how to reduce visibility of specific gateway&rsquo;s model only to components that need it. One side-effect of the cake pattern is that it allows a dependency injection resolved at compilation time.</p>

<p>In one of my last slides, I warned against abusing a dependency injection mechanism to write too much unit tests.
To stay within the time slot, I have not developed so much my concerns about that point.</p>

<p><img src="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-66-638.jpg"></p>

<p>During the talk, I implemented an application to demonstrate my points. This application consumes two external web services to render HTML pages. It is quite a typical application we can see in an infrastructure build with micro-services.</p>

<p>I&rsquo;ve now took the time to write a new version of this application I used in the demo.
<a href="https://github.com/yanns/TPA/tree/master/frontend/TBA_07">And This new version is not using any unit tests but only some sort of component tests.</a></p>

<p>Let&rsquo;s dig into the details how this new version differs from the ones build around the Cake pattern.</p>

<h3>Traditional view of unit tests</h3>

<p>When building an application, we usually structure the code into layers to separate responsibilities, thus enabling re-use of logic, and avoiding repetition.</p>

<p>In the demo I used for the talk, the application is for example layered into views, controllers, services and gateways. All these layers have access to a common model.</p>

<p><img src="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-10-638.jpg"" title="'code structured in layers'" ></p>

<p>A traditional approach of unit test is to consider one class or function of one layer as a unit to test. The other dependent layers are mocked.</p>

<p>For example, to test the service layers, we use mocks for the gateways, simulating responses from external web services.</p>

<p><img src="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-21-638.jpg"></p>

<p>This approach works well, but has several downsides:</p>

<ul>
<li>the unit tests prove that one layer is working as expected, but they said nothing about all the layers used together.</li>
<li>the unit tests use the internal details of the implementation. Re-factoring the code implies then to change a lot of tests.</li>
</ul>


<p>By using dependency injection and mocks, it is nowadays very easy to write unit tests. The effect if some applications are tested almost only with unit tests:</p>

<p><img src="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-65-638.jpg"></p>

<h3>Traditional view of component tests</h3>

<p>To complement the unit tests, a team can decide to implement some component tests.</p>

<p>For the sample used in the talk, the component is the font end application we are currently implementing.</p>

<p>The most common way to run component tests is to start the tested application. The application is configured not to use the real external web services, but some local mock implementations. The local mock implementations are started as http servers as well, running on different ports.</p>

<p><img src="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-13-638.jpg"></p>

<p>When the application and all the mocks are started, we can test the application by sending some http requests and by analyzing the responses.</p>

<p>Setting up the test environment with this approach is quite complex. For each external web service, a mock must be implemented as a real local http server. We must start all mock implementations, and then the new configured application. At the end of the tests, we must shutdown all services, even in case of exceptions.</p>

<p>But the main drawback with this approach in my opinion is that running the tests take a lot of time, too much to be integrated in a normal development flow (write code -> compile -> test)</p>

<h3>An alternative approach between component and unit tests</h3>

<p>To strictly adhere to the definition of component tests, we should treat the tested application as a black box, and simulate all external web services. We saw that this approach is somewhat heavy to use: each external web service must be mock with a real http server.</p>

<p>Starting and running the tests in that configuration take time. Debugging an error can be difficult.</p>

<p>The strategy I used in new version of the demo application (<a href="https://github.com/yanns/TPA/tree/master/frontend/TBA_07">TBA_07</a>) is a little bit different.
The idea is still to use a request / response to test the application, but without having to run the application and any external web services.</p>

<p>Implementing that is actually quite easy: each layer declared as dependency an HTTP client (a <a href="http://www.playframework.com/documentation/2.3.x/api/scala/index.html#play.api.libs.ws.WSClient">WSClient</a> in play framework 2.3)</p>

<ul>
<li>The http client is a dependency at the top (controllers' layer):</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">controllers</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Application</span><span class="o">(</span><span class="n">ws</span><span class="k">:</span> <span class="kt">WSClient</span><span class="o">,</span> <span class="n">app</span><span class="k">:</span> <span class="kt">play.api.Application</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">topVideoService</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TopVideoService</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="n">app</span><span class="o">)</span>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(a second &ldquo;dependency&rdquo; is the current play application. This approach is very convenient to simulate different configurations)</p>

<ul>
<li>The real implementation of the http client is then &ldquo;injected&rdquo; at the last time, when we construct the controller singleton:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">playCurrent</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="nc">Play</span><span class="o">.</span><span class="n">current</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nc">Application</span><span class="o">(</span><span class="nc">WS</span><span class="o">.</span><span class="n">client</span><span class="o">(</span><span class="n">playCurrent</span><span class="o">),</span> <span class="n">playCurrent</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>To test the application, we then simply have to instantiate the controller with an <a href="https://github.com/yanns/TPA/blob/master/frontend/TBA_07/test/httpclient/MockWS.scala">alternative implementation of the http client capable of simulating external web services</a>:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">ApplicationControllerFixture</span>
</span><span class='line'>  <span class="k">extends</span> <span class="nc">Application</span><span class="o">(</span><span class="nc">MockWS</span><span class="o">(</span><span class="n">playerRoute</span><span class="o">),</span> <span class="nc">FakeApplication</span><span class="o">())</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The <code>playerRoute</code> simulate the external player web service:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">playerId</span> <span class="k">=</span> <span class="nc">PlayerId</span><span class="o">(</span><span class="mi">34</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">playerRoute</span><span class="k">:</span> <span class="kt">MockWS.Routes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">,</span> <span class="n">u</span><span class="o">)</span> <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="n">s</span><span class="s">&quot;http://localhost:9001/players/$playerId&quot;</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">Action</span> <span class="o">{</span> <span class="nc">Ok</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">playerJson</span><span class="o">(</span><span class="n">playerId</span><span class="o">)))</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Action</span> <span class="o">{</span> <span class="nc">NotFound</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">playerJson</span><span class="o">(</span><span class="n">playerId</span><span class="k">:</span> <span class="kt">PlayerId</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">s</span><span class="s">&quot;&quot;&quot;{</span>
</span><span class='line'><span class="s">       |  &quot;id&quot;: $playerId,</span>
</span><span class='line'><span class="s">       |  &quot;name&quot;: &quot;ze name&quot;,</span>
</span><span class='line'><span class="s">       |  &quot;height&quot;: &quot;ze height&quot;,</span>
</span><span class='line'><span class="s">       |  &quot;weight&quot;: &quot;ze weight&quot;,</span>
</span><span class='line'><span class="s">       |  &quot;team&quot;: &quot;ze team&quot;</span>
</span><span class='line'><span class="s">       |}</span>
</span><span class='line'><span class="s">     &quot;&quot;&quot;</span><span class="o">.</span><span class="n">stripMargin</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>MockWS.Routes</code> type defines a partial function <code>PartialFunction[(String, String), EssentialAction]</code>, making really easy to combine different routes together with <code>orElse</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">SimulatedVideoBackend</span><span class="o">.</span><span class="n">videoRoute</span> <span class="n">orElse</span> <span class="nc">SimulatedPlayerBackend</span><span class="o">.</span><span class="n">playerRoute</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>and we can test the response by calling the controller with a <a href="http://www.playframework.com/documentation/2.3.x/api/scala/index.html#play.api.test.FakeRequest"><code>FakeRequest</code></a>:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">index</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="nc">FakeRequest</span><span class="o">())</span>
</span><span class='line'><span class="n">status</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="n">mustEqual</span> <span class="nc">OK</span>
</span></code></pre></td></tr></table></div></figure>


<p>The application is constructed as if it was depending from the http client and the current play application.</p>

<p>These tests are not strictly component tests, as we are not testing the real implementation of the http client.
The application is not entirely treated as a black box. But most of the code is tested like in production.</p>

<h4>Drawbacks of this approach:</h4>

<ul>
<li>writing a test is more complicated than testing a little unit of code</li>
<li>writing unit test can help avoiding code mixing responsibilities. We do not profit from that.</li>
<li>when a test suddenly fails, it is more difficult to find out why.</li>
<li>we do not test the complete application stack. For example, the <a href="http://www.playframework.com/documentation/2.3.x/ScalaHttpFilters">play filters</a> and the real http client is not tested.</li>
</ul>


<h4>Advantages of this approach:</h4>

<ul>
<li>a developer must understand how the application works in general to be able to write good tests</li>
<li>the application can be re-factored without modifying the tests</li>
<li>the user functions are better tested</li>
<li>the integration of all layers together is tested</li>
<li>we do not need any running server to check all the tests. The tests run very fast.</li>
<li>the code is simple (compare the <a href="https://github.com/yanns/TPA/blob/master/frontend/TBA_07/app/services/TopVideoService.scala">TopVideoService in that version</a> with the <a href="https://github.com/yanns/TPA/blob/master/frontend/TBA_05_final/app/services/TopVideoServiceComp.scala">one using the Cake pattern</a>)</li>
</ul>


<h3>Experience with that approach</h3>

<p>With one team, we are currently testing this approach. The results are quite encouraging: more than 80 % of the statements are covered by tests. We have more than 200 tests running in 10 seconds on my machine.</p>

<p>And I could deeply change the code with almost no impact on the tests. ;)</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo">
</footer>
  











</body>
</html>
