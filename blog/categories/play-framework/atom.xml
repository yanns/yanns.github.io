<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: play framework | yann's Blog]]></title>
  <link href="http://yanns.github.io/blog/categories/play-framework/atom.xml" rel="self"/>
  <link href="http://yanns.github.io/"/>
  <updated>2016-05-19T21:00:03+02:00</updated>
  <id>http://yanns.github.io/</id>
  <author>
    <name><![CDATA[Yann Simon]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[asynchronous IO for Play! applications in servlet 3.1 containers with the play2-war plugin]]></title>
    <link href="http://yanns.github.io/blog/2014/08/10/complete-asynchronous-io-for-play-applications-in-servlet-3-dot-1-containers-with-the-play2-war-plugin/"/>
    <updated>2014-08-10T18:55:36+02:00</updated>
    <id>http://yanns.github.io/blog/2014/08/10/complete-asynchronous-io-for-play-applications-in-servlet-3-dot-1-containers-with-the-play2-war-plugin</id>
    <content type="html"><![CDATA[<p>A <a href="http://playframework.com/">Play application</a> does not need any container and <a href="http://playframework.com/documentation/2.3.x/Production">runs directly in production</a>.</p>

<p>However some organizations prefer to run play applications within a servlet container and can use for this the <a href="https://github.com/play2war/play2-war-plugin">WAR Plugin</a>.</p>

<p>I am very pleased to share that this plugin is now compatible with servlet 3.1 containers. It can now use the new asynchronous IO possibilities.</p>

<p>Let me explain why and when it is important.</p>

<h3>Play applications are asynchronous</h3>

<p>The Play Framework is build to be totally asynchronous and reactive. It uses no blocking IO. A Play application scales very well, using very few threads.</p>

<p>This reactive consuming or construction of IO stream is designed in play with <a href="http://www.playframework.com/documentation/2.3.x/Iteratees">Iteratees</a>. It will progressively be completed with <a href="http://typesafe.com/blog/typesafe-announces-akka-streams">Akka Streams</a>, the implementation in Akka of the reactive stream project (<a href="http://www.reactive-streams.org/">http://www.reactive-streams.org/</a>)</p>

<h3>Servlet containers use blocking IO</h3>

<p>On the other hand, servlet containers traditionally use a <a href="http://www.slideshare.net/brikis98/the-play-framework-at-linkedin/62">thread per request</a>. When doing IO (database access, external web request), the thread waits for the IO completion (blocking IO). That&rsquo;s why servlet containers need a lot of working threads to handle requests in parallel (<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/executor.html">default 200 threads max for tomcat</a>)</p>

<h4>Asynchronous 3.0 servlet</h4>

<p>Servlet 3.0 containers introduced the possibility to “suspend” a request.
For example, if an application makes an HTTP request to another web service using the <a href="http://www.playframework.com/documentation/2.3.x/ScalaWS">WS client</a>, the play2 war plugin is able to suspend the servlet request until the external web service answers. It means that with the same number of servlet threads, a servlet 3.0 container can support more requests in parallel than a servlet 2.x container. It does not need that a thread waits for an HTTP request, this thread can be used for other requests.</p>

<h4>Limitations of asynchronous 3.0 servlet</h4>

<p>When uploading or downloading a big file, the servlet container is able to stream the data. But between each chunks, the servlet thread is blocking, waiting for the next one.
It is not possible to consume one chunk, and later, when we are ready to consume another one, tell the container: “now I am ready, you can send me the next chunk as soon as you receive one from the browser”.</p>

<p>If a browser needs an hour to upload a file with a slow Internet connection, the container needs a thread during an hour, even if the application does not do anything, just waiting for the upload completion.</p>

<h3>Play applications deployed as war are limited by the servlet container</h3>

<p>A Play application deployed in a war container is limited by the technical possibilites of the servlet API. With a servlet 2.x or 3.0, a Play application does not scale as well as when run natively.</p>

<h3>New asynchronous IO in servlet 3.1</h3>

<p>The <a href="https://jcp.org/en/jsr/detail?id=340">servlet 3.1 specification</a> added asynchronous IO. Based on <a href="http://docs.oracle.com/javase/7/docs/api/java/util/EventListener.html">events</a>, it is now possible to completly handle an <a href="https://javaee-spec.java.net/nonav/javadocs/javax/servlet/ReadListener.html">upload</a> and a <a href="https://javaee-spec.java.net/nonav/javadocs/javax/servlet/WriteListener.html">download</a> asynchronously.</p>

<h3>Asynchronous IO in WAR Plugin for Play! applications</h3>

<p>Since the <a href="https://github.com/play2war/play2-war-plugin/releases/tag/1.2">version 1.2</a>, the play2 war plugin is using this API to provide a complete reactive upload and download.</p>

<p>To use this, simply <a href="https://github.com/play2war/play2-war-plugin/wiki/Configuration#servlet-31-container-configuration">configure the servlet container version</a> and deploy to a servlet 3.1 server.</p>

<h4>When to use this feature?</h4>

<p>This feature should be used especially if the application is using big download/upload. The servlet 3.1 will help to scale much better.</p>

<p>During my tests, I could upload and download files from several GB in parallel. The container and the JVM garbage collection could support that without any problems. The memory usage was very low.</p>

<p>Also please test this new version and report issues!</p>

<h4>How to build the application to scale better?</h4>

<p>To scale as much as possible, the application should not block. It should always use asynchronous IO API like in the WS client.</p>

<p>But in the Java World a lot a librairies are still designed for a one-thread-per-request model and do not provide asynchronous API. It is for example the case for a JDBC driver. In that case, a separate dispatcher should be configured to handle blocking IO. More Information for this can be found in the <a href="http://www.playframework.com/documentation/2.3.x/ThreadPools">Play Framework documentation</a>.</p>

<h3>Implementation history</h3>

<p>The implementation of asynchronous IO in the WAR plugin lasted a few months.
The <a href="https://github.com/play2war/play2-war-plugin/pull/204">first pull request</a> introduced the asynchronous download, and <a href="https://github.com/play2war/play2-war-plugin/pull/235">the second one</a> the asynchronous upload.
I&rsquo;d like to thank <a href="https://twitter.com/jroper">James Roper</a> and <a href="https://twitter.com/viktorklang">Viktor Klang</a> for their reviews.</p>

<p>This feature was quite challenging to implement:</p>

<ul>
<li><p>I had to find a good way to implement the glue between two very different APIs. The servlet 3.1 API is quite imperative and use <a href="http://docs.oracle.com/javase/7/docs/api/java/util/EventListener.html">EventListener</a> and methods with side effects. The Iteratee API is functional and I needed some time to feel at ease with it.</p></li>
<li><p>The servlet 3.1 specification was recently finalized as I began. The first implementations in some containers contained bugs. Reporting the problems, explaining, convincing other developers took a lot of time and energy.</p></li>
<li><p>The servlet 3.1 specification is not always explicit. The implementations in the different servlet containers are also different. Finding an implementation that covers all these subtle differences was challenging. The <a href="https://play-war.ci.cloudbees.com/job/Play_2_War_Run_integration_tests_-_Play_22x/">testing infrastructure of the play2-war plugin</a> provides a lot of integration tests with different containers and helped a lot for this.</p></li>
</ul>


<p>My firm <a href="http://www.leanovate.de/">Leanovate</a> gave me some time to work on that. Having worked two days full time on it helped me a lot. Thanks Leanovate for this!</p>

<p>All in all it was a great experience to contribute to the WAR Plugin, and I hope my work will be useful for others.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[enlarge your test scope]]></title>
    <link href="http://yanns.github.io/blog/2014/05/30/enlarge-your-test-scope/"/>
    <updated>2014-05-30T22:00:22+02:00</updated>
    <id>http://yanns.github.io/blog/2014/05/30/enlarge-your-test-scope</id>
    <content type="html"><![CDATA[<p>At the beginning at the year, I had the chance to present <a href="blog/2014/02/17/ping-conf-2014/">how to organize a play application with the Cake pattern</a> at <a href="http://www.ping-conf.com/">Ping Conf</a>.
I showed how this pattern enable designing the application as components, how to reduce visibility of specific gateway&rsquo;s model only to components that need it. One side-effect of the cake pattern is that it allows a dependency injection resolved at compilation time.</p>

<p>In one of my last slides, I warned against abusing a dependency injection mechanism to write too much unit tests.
To stay within the time slot, I have not developed so much my concerns about that point.</p>

<p><img class="<a" src="href="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-66-638.jpg">http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-66-638.jpg</a>"></p>

<p>During the talk, I implemented an application to demonstrate my points. This application consumes two external web services to render HTML pages. It is quite a typical application we can see in an infrastructure build with micro-services.</p>

<p>I&rsquo;ve now took the time to write a new version of this application I used in the demo.
<a href="https://github.com/yanns/TPA/tree/master/frontend/TBA_07">And This new version is not using any unit tests but only some sort of component tests.</a></p>

<p>Let&rsquo;s dig into the details how this new version differs from the ones build around the Cake pattern.</p>

<h3>Traditional view of unit tests</h3>

<p>When building an application, we usually structure the code into layers to separate responsibilities, thus enabling re-use of logic, and avoiding repetition.</p>

<p>In the demo I used for the talk, the application is for example layered into views, controllers, services and gateways. All these layers have access to a common model.</p>

<p><img class="<a" src="href="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-10-638.jpg">http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-10-638.jpg</a>"" title="&lsquo;code structured in layers&rsquo;" ></p>

<p>A traditional approach of unit test is to consider one class or function of one layer as a unit to test. The other dependent layers are mocked.</p>

<p>For example, to test the service layers, we use mocks for the gateways, simulating responses from external web services.</p>

<p><img class="<a" src="href="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-21-638.jpg">http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-21-638.jpg</a>"></p>

<p>This approach works well, but has several downsides:</p>

<ul>
<li>the unit tests prove that one layer is working as expected, but they said nothing about all the layers used together.</li>
<li>the unit tests use the internal details of the implementation. Re-factoring the code implies then to change a lot of tests.</li>
</ul>


<p>By using dependency injection and mocks, it is nowadays very easy to write unit tests. The effect if some applications are tested almost only with unit tests:</p>

<p><img class="<a" src="href="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-65-638.jpg">http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-65-638.jpg</a>"></p>

<h3>Traditional view of component tests</h3>

<p>To complement the unit tests, a team can decide to implement some component tests.</p>

<p>For the sample used in the talk, the component is the font end application we are currently implementing.</p>

<p>The most common way to run component tests is to start the tested application. The application is configured not to use the real external web services, but some local mock implementations. The local mock implementations are started as http servers as well, running on different ports.</p>

<p><img class="<a" src="href="http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-13-638.jpg">http://image.slidesharecdn.com/play-with-cake-export2-140121150250-phpapp01/95/slide-13-638.jpg</a>"></p>

<p>When the application and all the mocks are started, we can test the application by sending some http requests and by analyzing the responses.</p>

<p>Setting up the test environment with this approach is quite complex. For each external web service, a mock must be implemented as a real local http server. We must start all mock implementations, and then the new configured application. At the end of the tests, we must shutdown all services, even in case of exceptions.</p>

<p>But the main drawback with this approach in my opinion is that running the tests take a lot of time, too much to be integrated in a normal development flow (write code -> compile -> test)</p>

<h3>An alternative approach between component and unit tests</h3>

<p>To strictly adhere to the definition of component tests, we should treat the tested application as a black box, and simulate all external web services. We saw that this approach is somewhat heavy to use: each external web service must be mock with a real http server.</p>

<p>Starting and running the tests in that configuration take time. Debugging an error can be difficult.</p>

<p>The strategy I used in new version of the demo application (<a href="https://github.com/yanns/TPA/tree/master/frontend/TBA_07">TBA_07</a>) is a little bit different.
The idea is still to use a request / response to test the application, but without having to run the application and any external web services.</p>

<p>Implementing that is actually quite easy: each layer declared as dependency an HTTP client (a <a href="http://www.playframework.com/documentation/2.3.x/api/scala/index.html#play.api.libs.ws.WSClient">WSClient</a> in play framework 2.3)</p>

<ul>
<li>The http client is a dependency at the top (controllers' layer):
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">controllers</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">Application</span><span class="o">(</span><span class="n">ws</span><span class="k">:</span> <span class="kt">WSClient</span><span class="o">,</span> <span class="n">app</span><span class="k">:</span> <span class="kt">play.api.Application</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">topVideoService</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TopVideoService</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="n">app</span><span class="o">)</span>
</span><span class='line'><span class="c1">//&amp;hellip;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure>
(a second &ldquo;dependency&rdquo; is the current play application. This approach is very convenient to simulate different configurations)</p>

<ul>
<li><p>The real implementation of the http client is then &ldquo;injected&rdquo; at the last time, when we construct the controller singleton:
<code>
def playCurrent = play.api.Play.current
object Application extends Application(WS.client(playCurrent), playCurrent)
</code></p></li>
<li><p>To test the application, we then simply have to instantiate the controller with an <a href="https://github.com/yanns/TPA/blob/master/frontend/TBA_07/test/httpclient/MockWS.scala">alternative implementation of the http client capable of simulating external web services</a>:
<code>scala
class ApplicationControllerFixture
extends Application(MockWS(playerRoute), FakeApplication())
</code></p></li>
<li><p>The <code>playerRoute</code> simulate the external player web service:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">playerId</span> <span class="k">=</span> <span class="nc">PlayerId</span><span class="o">(</span><span class="mi">34</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">val</span> <span class="n">playerRoute</span><span class="k">:</span> <span class="kt">MockWS.Routes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="nc">GET</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span> <span class="n">u</span><span class="o">)</span> <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="n">s</span><span class="s">&quot;&lt;a href=&quot;</span><span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9001</span><span class="kt">/players/$playerId</span><span class="err">&quot;</span><span class="kt">&gt;http://localhost:</span><span class="err">9001</span><span class="kt">/players/$playerId&lt;/a&gt;</span><span class="err">&quot;</span> <span class="o">=&gt;</span>
</span><span class='line'>    <span class="nc">Action</span> <span class="o">{</span> <span class="nc">Ok</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">playerJson</span><span class="o">(</span><span class="n">playerId</span><span class="o">)))</span> <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Action</span> <span class="o">{</span> <span class="nc">NotFound</span> <span class="o">}</span>
</span><span class='line'><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="n">playerJson</span><span class="o">(</span><span class="n">playerId</span><span class="k">:</span> <span class="kt">PlayerId</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">s</span><span class="err">&quot;</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;{</span>
</span><span class='line'>       <span class="o">|</span>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">id</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span><span class="k">:</span> <span class="kt">$playerId</span><span class="o">,</span>
</span><span class='line'>       <span class="o">|</span>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">name</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span><span class="k">:</span> <span class="kt">&amp;ldquo</span><span class="o">;</span><span class="n">ze</span> <span class="n">name</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span>
</span><span class='line'>       <span class="o">|</span>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">height</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span><span class="k">:</span> <span class="kt">&amp;ldquo</span><span class="o">;</span><span class="n">ze</span> <span class="n">height</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span>
</span><span class='line'>       <span class="o">|</span>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">weight</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span><span class="k">:</span> <span class="kt">&amp;ldquo</span><span class="o">;</span><span class="n">ze</span> <span class="n">weight</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span>
</span><span class='line'>       <span class="o">|</span>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">team</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span><span class="k">:</span> <span class="kt">&amp;ldquo</span><span class="o">;</span><span class="n">ze</span> <span class="n">team</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span>
</span><span class='line'>       <span class="o">|}</span>
</span><span class='line'>     <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;&amp;</span><span class="n">ldquo</span><span class="o">;.</span><span class="n">stripMargin</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The <code>MockWS.Routes</code> type defines a partial function <code>PartialFunction[(String, String), EssentialAction]</code>, making really easy to combine different routes together with <code>orElse</code>:
<code>scala
SimulatedVideoBackend.videoRoute orElse SimulatedPlayerBackend.playerRoute
</code></p>

<ul>
<li>and we can test the response by calling the controller with a <a href="http://www.playframework.com/documentation/2.3.x/api/scala/index.html#play.api.test.FakeRequest"><code>FakeRequest</code></a>:
<code>scala
val result = index.apply(FakeRequest())
status(result) mustEqual OK
</code></li>
</ul>


<p>The application is constructed as if it was depending from the http client and the current play application.</p>

<p>These tests are not strictly component tests, as we are not testing the real implementation of the http client.
The application is not entirely treated as a black box. But most of the code is tested like in production.</p>

<h4>Drawbacks of this approach:</h4>

<ul>
<li>writing a test is more complicated than testing a little unit of code</li>
<li>writing unit test can help avoiding code mixing responsibilities. We do not profit from that.</li>
<li>when a test suddenly fails, it is more difficult to find out why.</li>
<li>we do not test the complete application stack. For example, the <a href="http://www.playframework.com/documentation/2.3.x/ScalaHttpFilters">play filters</a> and the real http client is not tested.</li>
</ul>


<h4>Advantages of this approach:</h4>

<ul>
<li>a developer must understand how the application works in general to be able to write good tests</li>
<li>the application can be re-factored without modifying the tests</li>
<li>the user functions are better tested</li>
<li>the integration of all layers together is tested</li>
<li>we do not need any running server to check all the tests. The tests run very fast.</li>
<li>the code is simple (compare the <a href="https://github.com/yanns/TPA/blob/master/frontend/TBA_07/app/services/TopVideoService.scala">TopVideoService in that version</a> with the <a href="https://github.com/yanns/TPA/blob/master/frontend/TBA_05_final/app/services/TopVideoServiceComp.scala">one using the Cake pattern</a>)</li>
</ul>


<h3>Experience with that approach</h3>

<p>With one team, we are currently testing this approach. The results are quite encouraging: more than 80 % of the statements are covered by tests. We have more than 200 tests running in 10 seconds on my machine.</p>

<p>And I could deeply change the code with almost no impact on the tests. ;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SLF4J Mapped Diagnostic Context (MDC) with play framework]]></title>
    <link href="http://yanns.github.io/blog/2014/05/04/slf4j-mapped-diagnostic-context-mdc-with-play-framework/"/>
    <updated>2014-05-04T11:45:52+02:00</updated>
    <id>http://yanns.github.io/blog/2014/05/04/slf4j-mapped-diagnostic-context-mdc-with-play-framework</id>
    <content type="html"><![CDATA[<p>I&rsquo;d like the share with this post one solution I found to use a Mapped Diagnostic Context (MDC) in an asynchronous environment like the play framework.</p>

<h2>Edit (September 2014)</h2>

<p>Based on <a href="https://github.com/jroper/thread-local-context-propagation/">one implementation from James Roper</a>, I added one solution based on <a href="http://doc.akka.io/docs/akka/current/scala/dispatchers.html">Akka Dispatcher</a>.</p>

<h2>tl;dr</h2>

<p>This post provides two solution to propagate the MDC context in an asynchronous Play application:</p>

<ul>
<li>using a custom Akka <code>Dispatcher</code>. This solution needs minimal change to a current application.</li>
<li>using a custom <code>ExecutionContext</code> that propagates the MDC from the caller&rsquo;s thread to the callee&rsquo;s one. A custom <code>ActionBuilder</code> is necessary as well to completely use this custom <code>ExectionContext</code>.</li>
</ul>


<h2>The Mapped Diagnostic Context (MDC)</h2>

<p>The play framework uses for logging <a href="http://logback.qos.ch/">Logback</a> behind <a href="http://www.slf4j.org/">SLF4J (&ldquo;Simple Logging Facade for Java&rdquo;)</a>.<br/>
This library provides a convenient feature: the <a href="http://logback.qos.ch/manual/mdc.html">Mapped Diagnostic Context (MDC)</a>.
This context can be used to store values that can be displayed in every Logging statement.<br/>
For example, if we want to display the current user ID:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">org.slf4j.MDC</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="n">currentUser</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'><span class="nc">MDC</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;X-UserId&quot;</span><span class="o">,</span> <span class="n">currentUser</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// the block of code that uses the Logger</span>
</span><span class='line'>  <span class="c1">// for example:</span>
</span><span class='line'>  <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// clean up the MDC</span>
</span><span class='line'>  <span class="nc">MDC</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="s">&quot;X-UserId&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;(</span><span class="nc">This</span> <span class="n">code</span> <span class="n">could</span> <span class="n">be</span> <span class="n">in</span> <span class="n">a</span> <span class="o">[</span><span class="kt">filter</span><span class="o">](</span><span class="n">https</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="n">playframework</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">documentation</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="nc">ScalaHttpFilters</span><span class="o">),</span> <span class="n">run</span> <span class="k">for</span> <span class="n">each</span> <span class="n">request</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Logback</span> <span class="n">must</span> <span class="n">be</span> <span class="n">configured</span> <span class="n">to</span> <span class="n">display</span> <span class="n">the</span> <span class="n">`X-UserId`</span> <span class="n">value</span><span class="k">:</span>
</span><span class='line'><span class="kt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">appender</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;stdout&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">encoder</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">pattern</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;%</span><span class="n">d</span><span class="o">{</span><span class="nc">HH</span><span class="k">:</span><span class="kt">mm:ss.SSS</span><span class="o">}</span> <span class="o">%</span><span class="n">coloredLevel</span> <span class="o">%</span><span class="n">logger</span><span class="o">{</span><span class="mi">35</span><span class="o">}</span> <span class="o">%</span><span class="n">mdc</span><span class="o">{</span><span class="n">X</span><span class="o">-</span><span class="nc">UserId</span><span class="o">:--}</span> <span class="o">-</span> <span class="o">%</span><span class="n">msg</span><span class="o">%</span><span class="n">n</span><span class="o">%</span><span class="n">rootException</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">pattern</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">encoder</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">appender</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="nc">In</span> <span class="n">the</span> <span class="n">log</span> <span class="n">file</span><span class="o">,</span> <span class="n">the</span> <span class="nc">MDC</span> <span class="n">value</span> <span class="k">for</span> <span class="n">`X-UserId`</span> <span class="n">is</span> <span class="n">now</span> <span class="n">printed</span> <span class="n">out</span><span class="o">.</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="mi">10</span><span class="k">:</span><span class="err">50</span><span class="kt">:</span><span class="err">54</span><span class="kt">.</span><span class="err">773</span> <span class="err">[</span><span class="kt">info</span><span class="err">]</span> <span class="kt">application</span> <span class="kt">jean.leloup</span> <span class="kt">-</span> <span class="kt">test</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Limitation of the default implementation of the MDC</h2>

<p>To record the values in the MDC, Logback uses a <code>ThreadLocal</code> variable.
This strategy works when one thread is used for one request, like in servlet container before the 3.1 specification.</p>

<p>Play framework, on the other hand, is <a href="http://www.playframework.com/documentation/2.2.x/ScalaAsync">asynchronous</a>. The processing of a request is composed of several function calls, and each call can be run on a different thread. (&ldquo;Don&rsquo;t call me, I&rsquo;ll call you&rdquo;)</p>

<p>The implementation of the MDC with a <code>ThreadLocal</code> cannot work with this non-blocking asynchronous threading model.</p>

<h2>First solution with Akka Dispatcher</h2>

<h4>Defining a custom Akka dispatcher</h4>

<p>Play dispatchs the jobs on different threads with a <a href="https://www.playframework.com/documentation/latest/ThreadPools">thread pool</a>. The Play default thread pool is an <a href="http://doc.akka.io/docs/akka/current/scala/dispatchers.html">Akka dispatcher</a>.</p>

<p>To use the MDC, we provide a custom Akka <code>Dispatcher</code> that propagates the MDC from the caller&rsquo;s thread to the callee&rsquo;s one.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">monitoring</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">akka.dispatch._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">com.typesafe.config.Config</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.slf4j.MDC</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.duration.</span><span class="o">{</span><span class="nc">Duration</span><span class="o">,</span> <span class="nc">FiniteDuration</span><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">Configurator</span> <span class="k">for</span> <span class="n">a</span> <span class="nc">MDC</span> <span class="n">propagating</span> <span class="n">dispatcher</span><span class="o">.</span>
</span><span class='line'> <span class="o">*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">To</span> <span class="n">use</span> <span class="n">it</span><span class="o">,</span> <span class="n">configure</span> <span class="n">play</span> <span class="n">like</span> <span class="k">this:</span>
</span><span class='line'> <span class="kt">*</span> <span class="o">{{{</span>
</span><span class='line'> <span class="kt">*</span> <span class="kt">play</span> <span class="o">{</span>
</span><span class='line'> <span class="kt">*</span>   <span class="kt">akka</span> <span class="o">{</span>
</span><span class='line'> <span class="kt">*</span>     <span class="kt">actor</span> <span class="o">{</span>
</span><span class='line'> <span class="kt">*</span>       <span class="kt">default-dispatcher</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'> <span class="kt">*</span>         <span class="k">type</span> <span class="o">=</span> <span class="kt">&amp;ldquo</span><span class="o">;</span><span class="kt">monitoring.MDCPropagatingDispatcherConfigurator&amp;rdquo</span><span class="o">;</span>
</span><span class='line'> <span class="kt">*</span>       <span class="o">}</span>
</span><span class='line'> <span class="kt">*</span>     <span class="o">}</span>
</span><span class='line'> <span class="kt">*</span>   <span class="o">}</span>
</span><span class='line'> <span class="kt">*</span> <span class="o">}</span>
</span><span class='line'> <span class="o">*</span> <span class="o">}}}</span>
</span><span class='line'> <span class="o">*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">Credits</span> <span class="n">to</span> <span class="nc">James</span> <span class="nc">Roper</span> <span class="k">for</span> <span class="n">the</span> <span class="o">[[</span><span class="kt">&lt;a</span> <span class="kt">href=</span><span class="err">&quot;</span><span class="kt">https://github.com/jroper/thread-local-context-propagation/</span><span class="err">&quot;</span><span class="kt">&gt;https://github.com/jroper/thread-local-context-propagation/&lt;/a&gt;</span> <span class="kt">initial</span> <span class="kt">implementation</span><span class="o">]]</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MDCPropagatingDispatcherConfigurator</span><span class="o">(</span><span class="n">config</span><span class="k">:</span> <span class="kt">Config</span><span class="o">,</span> <span class="n">prerequisites</span><span class="k">:</span> <span class="kt">DispatcherPrerequisites</span><span class="o">)</span>
</span><span class='line'>  <span class="k">extends</span> <span class="nc">MessageDispatcherConfigurator</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">prerequisites</span><span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">private</span> <span class="k">val</span> <span class="n">instance</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MDCPropagatingDispatcher</span><span class="o">(</span>
</span><span class='line'>    <span class="k">this</span><span class="o">,</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">id</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;),</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">getInt</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">throughput</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;),</span>
</span><span class='line'>    <span class="nc">FiniteDuration</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="n">getDuration</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">throughput</span><span class="o">-</span><span class="n">deadline</span><span class="o">-</span><span class="n">time</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">NANOSECONDS</span><span class="o">),</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">NANOSECONDS</span><span class="o">),</span>
</span><span class='line'>    <span class="n">configureExecutor</span><span class="o">(),</span>
</span><span class='line'>    <span class="nc">FiniteDuration</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="n">getDuration</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">shutdown</span><span class="o">-</span><span class="n">timeout</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">MILLISECONDS</span><span class="o">),</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">MILLISECONDS</span><span class="o">))&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">override</span> <span class="k">def</span> <span class="n">dispatcher</span><span class="o">()</span><span class="k">:</span> <span class="kt">MessageDispatcher</span> <span class="o">=</span> <span class="n">instance</span>
</span><span class='line'><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'> <span class="o">*</span> <span class="n">A</span> <span class="nc">MDC</span> <span class="n">propagating</span> <span class="n">dispatcher</span><span class="o">.</span>
</span><span class='line'> <span class="o">*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">This</span> <span class="n">dispatcher</span> <span class="n">propagates</span> <span class="n">the</span> <span class="nc">MDC</span> <span class="n">current</span> <span class="n">request</span> <span class="n">context</span> <span class="k">if</span> <span class="n">it</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="o">;</span><span class="n">s</span> <span class="n">set</span> <span class="n">when</span> <span class="n">it</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="o">;</span><span class="n">s</span> <span class="n">executed</span><span class="o">.</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MDCPropagatingDispatcher</span><span class="o">(&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">configurator</span><span class="k">:</span> <span class="kt">MessageDispatcherConfigurator</span><span class="o">,</span>
</span><span class='line'>                               <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>                               <span class="n">throughput</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
</span><span class='line'>                               <span class="n">throughputDeadlineTime</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">,</span>
</span><span class='line'>                               <span class="n">executorServiceFactoryProvider</span><span class="k">:</span> <span class="kt">ExecutorServiceFactoryProvider</span><span class="o">,</span>
</span><span class='line'>                               <span class="n">shutdownTimeout</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span>
</span><span class='line'>  <span class="k">extends</span> <span class="nc">Dispatcher</span><span class="o">(&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">configurator</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">throughput</span><span class="o">,</span> <span class="n">throughputDeadlineTime</span><span class="o">,</span> <span class="n">executorServiceFactoryProvider</span><span class="o">,</span> <span class="n">shutdownTimeout</span> <span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">self</span> <span class="o">=&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">override</span> <span class="k">def</span> <span class="n">prepare</span><span class="o">()</span><span class="k">:</span> <span class="kt">ExecutionContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExecutionContext</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// capture the MDC</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">mdcContext</span> <span class="k">=</span> <span class="nc">MDC</span><span class="o">.</span><span class="n">getCopyOfContextMap</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="n">execute</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Runnable</span><span class="o">)</span> <span class="k">=</span> <span class="n">self</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">run</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// backup the callee MDC context</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">oldMDCContext</span> <span class="k">=</span> <span class="nc">MDC</span><span class="o">.</span><span class="n">getCopyOfContextMap</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Run the runnable with the captured context</span>
</span><span class='line'>    <span class="n">setContextMap</span><span class="o">(</span><span class="n">mdcContext</span><span class="o">)</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">r</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// restore the callee MDC context</span>
</span><span class='line'>      <span class="n">setContextMap</span><span class="o">(</span><span class="n">oldMDCContext</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">})</span>
</span><span class='line'><span class="k">def</span> <span class="n">reportFailure</span><span class="o">(</span><span class="n">t</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="k">=</span> <span class="n">self</span><span class="o">.</span><span class="n">reportFailure</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">setContextMap</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">java.util.Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="nc">MDC</span><span class="o">.</span><span class="n">clear</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="nc">MDC</span><span class="o">.</span><span class="n">setContextMap</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure>
</p>

<h4>Using a custom Akka dispatcher everywhere:</h4>

<p>To use this custom Akka dispatcher everywhere, we just have to configure it:
<code>bash application.conf
play {
  akka {
    actor {
      default-dispatcher = {
        type = "monitoring.MDCPropagatingDispatcherConfigurator"
      }
    }
  }
}
</code>
and that&rsquo;s all! ;)</p>

<p>The MDC context is propagated when we use the play default <a href="https://www.playframework.com/documentation/2.3.x/api/scala/index.html#play.api.libs.concurrent.Execution$"><code>ExecutionContext</code></a>.</p>

<h4>Optimization</h4>

<p>So that this approach works in dev mode, simply make a library (jar) of this custom Akka dispatcher and add this as dependency in your play application.</p>

<h2>Second solution with a custom execution context</h2>

<h4>Defining a custom execution context</h4>

<p>The dispatching of the jobs on different threads in done with an <code>ExecutionContext</code>. Each <code>ExecutionContext</code> manages a <a href="https://www.playframework.com/documentation/latest/ThreadPools">thread pool</a>.</p>

<p>To use the MDC, we just have to use a custom <code>ExecutionContext</code> that propagates the MDC from the caller&rsquo;s thread to the callee&rsquo;s one.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">org.slf4j.MDC</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.</span><span class="o">{</span><span class="nc">ExecutionContextExecutor</span><span class="o">,</span> <span class="nc">ExecutionContext</span><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'> <span class="o">*</span> <span class="n">slf4j</span> <span class="n">provides</span> <span class="n">a</span> <span class="nc">MDC</span> <span class="o">[[</span><span class="kt">&lt;a</span> <span class="kt">href=</span><span class="err">&quot;</span><span class="kt">http://logback.qos.ch/manual/mdc.html</span><span class="err">&quot;</span><span class="kt">&gt;http://logback.qos.ch/manual/mdc.html&lt;/a&gt;</span> <span class="kt">Mapped</span> <span class="kt">Diagnostic</span> <span class="kt">Context</span><span class="o">]]</span>
</span><span class='line'> <span class="o">*</span> <span class="n">based</span> <span class="n">on</span> <span class="n">a</span> <span class="o">[[</span><span class="kt">ThreadLocal</span><span class="o">]].</span> <span class="nc">In</span> <span class="n">an</span> <span class="n">asynchronous</span> <span class="n">environment</span><span class="o">,</span> <span class="n">the</span> <span class="n">callbacks</span> <span class="n">can</span> <span class="n">be</span> <span class="n">called</span>
</span><span class='line'> <span class="o">*</span> <span class="n">in</span> <span class="n">another</span> <span class="n">thread</span><span class="o">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">local</span> <span class="n">thread</span> <span class="n">variable</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span> <span class="n">anymore</span><span class="o">.</span>
</span><span class='line'> <span class="o">*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">This</span> <span class="n">execution</span> <span class="n">context</span> <span class="n">fixes</span> <span class="k">this</span> <span class="n">problem</span><span class="k">:</span>
</span><span class='line'> <span class="kt">*</span> <span class="kt">it</span> <span class="kt">propagates</span> <span class="kt">the</span> <span class="kt">MDC</span> <span class="kt">from</span> <span class="kt">the</span> <span class="kt">caller&amp;rsquo</span><span class="o">;</span><span class="n">s</span> <span class="n">thread</span> <span class="n">to</span> <span class="n">the</span> <span class="n">callee</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="o">;</span><span class="n">s</span> <span class="n">one</span><span class="o">.</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">object</span> <span class="nc">MDCHttpExecutionContext</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'>   <span class="o">*</span> <span class="nc">Create</span> <span class="n">an</span> <span class="nc">MDCHttpExecutionContext</span> <span class="k">with</span> <span class="n">values</span> <span class="n">from</span> <span class="n">the</span> <span class="n">current</span> <span class="n">thread</span><span class="o">.</span>
</span><span class='line'>   <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">fromThread</span><span class="o">(</span><span class="n">delegate</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">ExecutionContextExecutor</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">MDCHttpExecutionContext</span><span class="o">(</span><span class="nc">MDC</span><span class="o">.</span><span class="n">getCopyOfContextMap</span><span class="o">,</span> <span class="n">delegate</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">Manages</span> <span class="n">execution</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">that</span> <span class="n">the</span> <span class="n">given</span> <span class="nc">MDC</span> <span class="n">context</span> <span class="n">are</span> <span class="n">set</span> <span class="n">correctly</span>
</span><span class='line'> <span class="o">*</span> <span class="n">in</span> <span class="n">the</span> <span class="n">current</span> <span class="n">thread</span><span class="o">.</span> <span class="nc">Actual</span> <span class="n">execution</span> <span class="n">is</span> <span class="n">performed</span> <span class="n">by</span> <span class="n">a</span> <span class="n">delegate</span> <span class="nc">ExecutionContext</span><span class="o">.</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MDCHttpExecutionContext</span><span class="o">(</span><span class="n">mdcContext</span><span class="k">:</span> <span class="kt">java.util.Map</span><span class="o">[</span><span class="kt">&lt;em&gt;</span>, <span class="kt">&lt;/em&gt;</span><span class="o">],</span> <span class="n">delegate</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ExecutionContextExecutor</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">execute</span><span class="o">(</span><span class="n">runnable</span><span class="k">:</span> <span class="kt">Runnable</span><span class="o">)</span> <span class="k">=</span> <span class="n">delegate</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">oldMDCContext</span> <span class="k">=</span> <span class="nc">MDC</span><span class="o">.</span><span class="n">getCopyOfContextMap</span>
</span><span class='line'>      <span class="n">setContextMap</span><span class="o">(</span><span class="n">mdcContext</span><span class="o">)</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">runnable</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">setContextMap</span><span class="o">(</span><span class="n">oldMDCContext</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">})&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">setContextMap</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">java.util.Map</span><span class="o">[</span><span class="kt">&lt;em&gt;</span>, <span class="kt">&lt;/em&gt;</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="nc">MDC</span><span class="o">.</span><span class="n">clear</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="nc">MDC</span><span class="o">.</span><span class="n">setContextMap</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="n">reportFailure</span><span class="o">(</span><span class="n">t</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="k">=</span> <span class="n">delegate</span><span class="o">.</span><span class="n">reportFailure</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Then we can define the default ExecutionContext in our application:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">concurrent</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">The</span> <span class="n">standard</span> <span class="o">[[</span><span class="kt">play.api.libs.concurrent.Execution.defaultContext</span><span class="o">]]</span> <span class="n">loses</span> <span class="n">the</span> <span class="nc">MDC</span> <span class="n">context</span><span class="o">.</span>
</span><span class='line'> <span class="o">*</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">This</span> <span class="n">custom</span> <span class="o">[[</span><span class="kt">ExecutionContext</span><span class="o">]]</span> <span class="n">propagates</span> <span class="n">the</span> <span class="nc">MDC</span> <span class="n">context</span><span class="o">,</span> <span class="n">so</span> <span class="n">that</span> <span class="n">the</span> <span class="n">request</span>
</span><span class='line'> <span class="o">*</span> <span class="n">and</span> <span class="n">the</span> <span class="n">correlation</span> <span class="nc">IDs</span> <span class="n">can</span> <span class="n">be</span> <span class="n">logged</span><span class="o">.</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Execution</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">object</span> <span class="nc">Implicits</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">implicit</span> <span class="k">def</span> <span class="n">defaultContext</span><span class="k">:</span> <span class="kt">ExecutionContext</span> <span class="o">=</span> <span class="nc">Execution</span><span class="o">.</span><span class="n">defaultContext</span>
</span><span class='line'>  <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="n">defaultContext</span><span class="k">:</span> <span class="kt">ExecutionContext</span> <span class="o">=</span> <span class="nc">MDCHttpExecutionContext</span><span class="o">.</span><span class="n">fromThread</span><span class="o">(</span><span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">Execution</span><span class="o">.</span><span class="n">defaultContext</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now we will use the <code>concurrent.Execution.defaultContext</code> instead of the one from play (<code>play.api.libs.concurrent.Execution.defaultContext</code>)</p>

<h4>Using a custom execution context everywhere</h4>

<p>Using a custom execution context is sometimes as easy as replacing
<code>import play.api.libs.concurrent.Execution.Implicits._</code> with <code>import concurrent.Execution.Implicits._</code></p>

<p>The default <a href="https://www.playframework.com/documentation/latest/ScalaActions"><code>Action</code></a> uses the default <code>play.api.libs.concurrent.Execution.defaultContext</code>.
We must define a custom <code>ActionBuilder</code> that uses our new <code>ExecutionContext</code>:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">controllers</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">Action</span> <span class="k">extends</span> <span class="nc">ActionBuilder</span><span class="o">[</span><span class="kt">Request</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">invokeBlock</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;request:%20Request[A],%20block:%20(Request[A]&quot;</span><span class="o">&gt;</span><span class="n">A</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">SimpleResult</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">block</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'>   <span class="o">*</span> <span class="nc">The</span> <span class="n">standard</span> <span class="o">[[</span><span class="kt">play.api.mvc.Action</span><span class="o">]]</span> <span class="n">loses</span> <span class="n">the</span> <span class="nc">MDC</span> <span class="n">context</span><span class="o">.</span>
</span><span class='line'>   <span class="o">*</span>
</span><span class='line'>   <span class="o">*</span> <span class="nc">This</span> <span class="n">action</span> <span class="n">builder</span> <span class="n">sets</span> <span class="n">the</span> <span class="o">[[</span><span class="kt">ExecutionContext</span><span class="o">]]</span> <span class="n">so</span> <span class="n">that</span> <span class="n">the</span>
</span><span class='line'>   <span class="o">*</span> <span class="nc">MDC</span> <span class="n">context</span> <span class="n">is</span> <span class="n">propagated</span><span class="o">.</span>
</span><span class='line'>   <span class="o">*</span> <span class="nc">With</span> <span class="k">this</span> <span class="n">custom</span> <span class="o">[[</span><span class="kt">ExecutionContext</span><span class="o">]],</span> <span class="n">the</span> <span class="n">request</span> <span class="n">and</span> <span class="n">the</span> <span class="n">correlation</span> <span class="nc">IDs</span>
</span><span class='line'>   <span class="o">*</span> <span class="n">can</span> <span class="n">be</span> <span class="n">logged</span><span class="o">.</span>
</span><span class='line'>   <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">executionContext</span><span class="k">:</span> <span class="kt">ExecutionContext</span> <span class="o">=</span> <span class="nc">Execution</span><span class="o">.</span><span class="n">defaultContext</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Instead of using of <code>play.api.mvc.Action</code>, we just have to use the newly defined <code>controllers.Action</code>.</p>

<p>With each of these customizations, we are now able to use the Mapped Diagnostic Context (MDC) with asynchronous actions written in Scala.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Server side rendering for JavaScript ReactJS framework]]></title>
    <link href="http://yanns.github.io/blog/2014/03/15/server-side-rendering-for-javascript-reactjs-framework/"/>
    <updated>2014-03-15T09:44:00+01:00</updated>
    <id>http://yanns.github.io/blog/2014/03/15/server-side-rendering-for-javascript-reactjs-framework</id>
    <content type="html"><![CDATA[<h2>Flicker effect with JavaScript applications</h2>

<p>A lot of web applications are nowadays build with a JavaScript framework, rendering the HTML in the browser (client side).
There are a few reasons for this, like:</p>

<ul>
<li>avoiding server-browser round-trips to modify one HTML element</li>
<li>it is easier to keep the server side stateless if you maintain the state in the browser</li>
<li>the server can expose a public REST API for partners. And your own JavaScript application can use this API, encouraging <a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food">eating our own dog food</a></li>
</ul>


<p>Building a client side JavaScript application is not always easy for teams used to server side code, and a few frameworks can help there, like <a href="http://angularjs.org/">AngularJS</a>, <a href="http://emberjs.com/">Ember</a> or <a href="http://facebook.github.io/react/">React</a></p>

<p>We will look at an <a href="http://play-react.herokuapp.com/clientSide">example with React</a></p>

<p>To display the HTML, a few steps are needed:</p>

<ol>
<li><p>The browser loads HTML, CSS and JavaScript.<br>
It displays the HTML delivered directly by the server.<br>
 <img src="/assets/2014-03-15/server.png" alt="The browser shows the HTML coming from the server" /></p>

<p> With AngularJS, if <a href="http://docs.angularjs.org/guide/expression">inline expression</a> are used, the user can see the following for a few milliseconds:<br/>
 hello <br/>
 before AngularJS replaces this expression with its computed value.</p></li>
<li><p>The JavaScript framework manipulates the DOM and the user can then see the application.
 <img src="/assets/2014-03-15/server_and_client.png" alt="The JavaScript application has changed the DOM" /></p></li>
<li><p>If the application needs to display some data from the server, it must first request it with Ajax. The data is displayed only after being received by the browser.
 <img src="/assets/2014-03-15/server_and_client_and_data.png" alt="The JavaScript application has received data and changed the DOM accordingly" /></p></li>
</ol>


<p>(to make the <a href="http://play-react.herokuapp.com/clientSide">flicker</a> more visible, I introduced a latency of 500 ms to simulate a slow backend)</p>

<p>The user experience is not optimal. The application flickers at each step, as the DOM is changed several times in a few seconds.</p>

<h2>Avoiding the flicker effect</h2>

<h3>On the client side</h3>

<p>In the browser, we can mitigate the flicker effect.
Some applications show a spinner as long as the page is not ready to be shown.
The not-yet-completed DOM is hidden before being shown in one final step.</p>

<p>For example, AngularJS provides the <a href="http://docs.angularjs.org/api/ng/directive/ngCloak">ng-cloak directive</a>.
With this directive, AngularJS can hide the HTML as long as it is not ready.</p>

<h3>Welcome back to server side rendering</h3>

<p>Instead of rendering everything in the browser, it is also possible to first render the page on the server side, serve it when ready, and when updating it on the client side when necessary.</p>

<p>(Please notice that this technic allows the HTML to be indexed for search engines that do not execute the JavaScript.)</p>

<p>From example, React can render a UI component without any browser with <a href="http://facebook.github.io/react/docs/top-level-api.html#react.rendercomponenttostring">React.renderComponentToString</a>.</p>

<p>With this function, the complete page can be prepared on the server side, send under this form to the browser that can directly display the ready application. On the client side, the same JavaScript code can dynamically manipulate this DOM as a normal client side application.</p>

<p>The <a href="https://github.com/mhart/react-server-example">React server rendering example</a> demonstrates how to use React&rsquo;s server rendering capabilities. Rendering a JavaScript application on the server side is technically possible because the JavaScript is executed by <a href="http://nodejs.org/">Node.js</a>.</p>

<h3>And what about the JVM?</h3>

<p>If you are not using NodeJS, but the Java Virtual Machine (JVM), you might be disappointed at this time.
Pre-render a JavaScript application is only possible with Node.js?</p>

<p>In Java, there are a few projects that can save us:</p>

<ul>
<li><p><a href="https://github.com/apigee/trireme">trireme</a> provides a Node.js API and can run node.js scripts inside Java. It uses Rhino, the current JavaScript implementation for the JVM. (With Java 8, let&rsquo;s see if trireme will use the new JavaScript implementation, Nashorn, or whether Nashorn will implement the node.js API itself.)</p></li>
<li><p><a href="https://github.com/typesafehub/js-engine">js-engine</a> provides <a href="http://akka.io/">Akka Actors</a> to execute JavaScript code with trireme or with node.js</p></li>
</ul>


<p>As a proof of concept, I implemented a little play application that uses these projects to pre-render a React component on the server side.</p>

<p>The JavaScript is loaded:
<code>scala
val serverside = Play.getFile("public/javascripts/serverside.js")
</code></p>

<p>An actor is created for a JavaScript engine (trireme or node.js)
<code>scala
val engine = Akka.system.actorOf(jsEngine, s"engine-${request.id}")
</code></p>

<p>We receive the data from the database:
<code>scala
data &lt;- initialData
</code>
and let the JavaScript code execute with that data as parameter
<code>scala
result &lt;- (engine ? Engine.ExecuteJs(new File(serverside.toURI), List(data))).mapTo[JsExecutionResult]
</code>
The result is send to the browser
<code>scala
Ok(views.html.index(Html(new String(result.output.toArray, "UTF-8"))))
</code>
complete controller code:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="c1">// with js-engine</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">serverSideTrireme</span> <span class="k">=</span> <span class="n">serverSideWithJsEngine</span><span class="o">(</span><span class="nc">Trireme</span><span class="o">.</span><span class="n">props</span><span class="o">())&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="c1">// with node</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">serverSideNode</span> <span class="k">=</span> <span class="n">serverSideWithJsEngine</span><span class="o">(</span><span class="nc">Node</span><span class="o">.</span><span class="n">props</span><span class="o">())&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">private</span> <span class="k">def</span> <span class="n">serverSideWithJsEngine</span><span class="o">(</span><span class="n">jsEngine</span><span class="k">:</span> <span class="kt">Props</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">.</span><span class="n">async</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">import</span> <span class="nn">akka.pattern.ask</span>
</span><span class='line'>    <span class="k">import</span> <span class="nn">scala.concurrent.duration._&lt;/p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">val</span> <span class="n">serverside</span> <span class="k">=</span> <span class="nc">Play</span><span class="o">.</span><span class="n">getFile</span><span class="o">(</span><span class="s">&quot;public/javascripts/serverside.js&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Timeout</span><span class="o">(</span><span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">engine</span> <span class="k">=</span> <span class="nc">Akka</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="n">jsEngine</span><span class="o">,</span> <span class="n">s</span><span class="s">&quot;engine-${request.id}&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="n">initialData</span>
</span><span class='line'>  <span class="n">result</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="o">(</span><span class="n">engine</span> <span class="o">?</span> <span class="nc">Engine</span><span class="o">.</span><span class="nc">ExecuteJs</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">serverside</span><span class="o">.</span><span class="n">toURI</span><span class="o">),</span> <span class="nc">List</span><span class="o">(</span><span class="n">data</span><span class="o">))).</span><span class="n">mapTo</span><span class="o">[</span><span class="kt">JsExecutionResult</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">(</span><span class="n">views</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="o">(</span><span class="nc">Html</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">toArray</span><span class="o">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">))))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The code <code>serverside.js</code> uses the <a href="http://nodejs.org/api/modules.html#modules_module_require_id">node.js modules API</a> to render our main component (CommentBox).
<code>javascript
var React = require('./react'),
    CommentBox = require('./CommentBox');
</code></p>

<p>It then loads the data given as first parameter in the controller
<code>javascript
// take data from parameters
var data = JSON.parse(process.argv[2]);
</code></p>

<p>It renders the CommentBox component to a String and output it to console.log so that the Scala controller can receive the result with <code>result.output.toArray</code></p>

<pre><code class="javascript">console.log(React.renderComponentToString(CommentBox(backend)({data: data, onServerSide: true})));
</code></pre>

<p>Complete code:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">React</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;.</span><span class="o">/</span><span class="nx">react</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;),</span>
</span><span class='line'>    <span class="nx">CommentBox</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;.</span><span class="o">/</span><span class="nx">CommentBox</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;);</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">// take data from parameters</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">var</span> <span class="nx">backend</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">loadCommentsFromServer</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">handleCommentSubmit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">React</span><span class="p">.</span><span class="nx">renderComponentToString</span><span class="p">(</span><span class="nx">CommentBox</span><span class="p">(</span><span class="nx">backend</span><span class="p">)({</span><span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">onServerSide</span><span class="o">:</span> <span class="kc">true</span><span class="p">})));</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><a href="http://play-react.herokuapp.com/serverSide">This page</a> does not flicker anymore compared to the <a href="http://play-react.herokuapp.com/clientSide">first version</a>.</p>

<h3>Drawback with server side rendering</h3>

<p>The drawback with pre-rendering the page on the server side is that we have to wait to have all the data before sending the page.
In the <a href="http://play-react.herokuapp.com/serverSide">sample application</a>, I introduced a latency when requesting the data to simulate a slow database.</p>

<p>The browser must also wait long before getting any HTML. The following diagram shows that the application (deployed on Heroku) needs more than one second to deliver the page!
<img src="/assets/2014-03-15/wait_for_server.png" alt="The browser is waiting for the server" /></p>

<h3>Can we optimize more?</h3>

<p>We can optimize this version by sending the first bytes of the HTML page before having any data.
When the data is there, we can send the rest of the page.</p>

<p>With <a href="http://play-react.herokuapp.com/serverSideStream">that variant</a>, we can include the CSS and part of the JavaScript in the \&lt;HEAD> section of the HTML page.
The browser receives this information very quickly and can begin downloading these assets.
The server lets the connection open and when the rest of the page is ready, it is send to the browser.</p>

<p><img src="/assets/2014-03-15/browser_loads_assets.png" alt="The browser can load the CSS and JavaScript" /></p>

<p>To implement this, I used the Facebook’s BigPipe concept as presented in the <a href="http://de.slideshare.net/brikis98/composable-and-streamable-play-apps">talk “Building composable, streaming, testable Play apps” from Yevgeniy Brikman</a></p>

<p>It is not a &ldquo;Silver Bullet&rdquo; as we are still waiting for the data before displaying it to the user (that makes sense).
But the browser can load the stylesheets, the JavaScripts very quickly, leading to a more responsive page.</p>

<h2>Integrate Play and trireme</h2>

<p>To resolve node.js modules, trireme needs to access the JavaScripts directly on the file system.
But Play Framework package all the public assets in the jar, making the JavaScript assets not available with <a href="http://www.playframework.com/documentation/2.2.x/api/scala/index.html#play.api.Play$">Play.getFile</a></p>

<p>It would be easier if trireme would use a <a href="http://docs.oracle.com/javase/7/docs/api/java/nio/file/FileSystem.html">FileSystem</a> object, but this API is only available from Java 7.</p>

<p>To wordaround this, I configured the <a href="https://github.com/sbt/sbt-native-packager">SBT Universal plugin</a> to deploy the public assets to the file system:</p>

<ul>
<li>in build.sbt:
<code>scala
PublicOnFileSystem.settings
</code></li>
<li>project/PublicOnFileSystem.scala
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">sbt.</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">sbt.Keys.</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.Keys.playAssetsDirectories</span>
</span><span class='line'><span class="k">import</span> <span class="nn">com.typesafe.sbt.SbtNativePackager._&lt;/li</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">PublicOnFileSystem</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">settings</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="n">mappings</span> <span class="n">in</span> <span class="nc">Universal</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;++=</span> <span class="n">playAssetsDirectories</span> <span class="n">map</span> <span class="o">{</span> <span class="n">directories</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="n">directories</span><span class="o">.</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">dir</span><span class="k">:</span> <span class="kt">File</span> <span class="o">=&gt;</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">directoryLen</span> <span class="k">=</span> <span class="n">dir</span><span class="o">.</span><span class="n">getCanonicalPath</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">pathFinder</span> <span class="k">=</span> <span class="n">dir</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;*</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&lt;/</span><span class="n">em</span><span class="o">&gt;&amp;</span><span class="n">rdquo</span><span class="o">;</span>
</span><span class='line'>        <span class="n">pathFinder</span><span class="o">.</span><span class="n">get</span> <span class="n">map</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">publicFile</span><span class="k">:</span> <span class="kt">File</span> <span class="o">=&gt;</span>
</span><span class='line'>            <span class="n">publicFile</span> <span class="o">-&gt;</span> <span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">public</span><span class="o">/&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">+</span> <span class="n">publicFile</span><span class="o">.</span><span class="n">getCanonicalPath</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="n">directoryLen</span><span class="o">))</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Conclusion</h2>

<p>I personaly think that we will more and more use JavaScript even on the server side.
Projects like <a href="http://vertx.io/">Vert.x</a> are interesting because they support this from the beginning.
With Play Framework on the JVM, there is currently <a href="http://openjdk.java.net/projects/nashorn/">a</a> <a href="https://github.com/typesafehub/webdriver">lot</a> <a href="https://github.com/typesafehub/js-engine">of</a> <a href="https://github.com/sbt/sbt-web">effort</a> <a href="http://www.webjars.org/">put</a> to support that.</p>

<p>This proof of concept shows that it is already possible to achieve that.
And I guess it will be even easier in the future.</p>

<p>If you need more information, the <a href="https://github.com/yanns/play-react">code is available on github</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ping conf 2014]]></title>
    <link href="http://yanns.github.io/blog/2014/02/17/ping-conf-2014/"/>
    <updated>2014-02-17T16:49:00+01:00</updated>
    <id>http://yanns.github.io/blog/2014/02/17/ping-conf-2014</id>
    <content type="html"><![CDATA[<p>In January, I had the pleasure to participate and give a talk at the <a href="http://www.ping-conf.com/">ping conf</a>.</p>

<p>Ping conf was the first world wide community conference about the <a href="http://www.playframework.com/">Play Framework!</a>.</p>

<p>This conference was very well organized. I&rsquo;d like to thank all the organizers one more time for this.
It was a good opportunity to meet people I only knew online from the mailing list or on twitter.</p>

<p>The talks were very interesting. Some notices:</p>

<h4>&ldquo;Javascript functionality coming to Play 2.3&rdquo; from <a href="https://twitter.com/huntchr">Christopher Hunt</a></h4>

<p>Typesafe take the JavaScript build chain very seriously and the new <a href="https://github.com/sbt/sbt-web">sbt-web</a> offers a lot of new functionalities.
IMO, one of the most important is the possibility to use NodeJS as JavaScript engine. The performance of the JavaScript build pipeline in Play is similar or even better than the ones based on NodeJS (like Grunt or Gulp)<br/>
<a href="http://huntc.github.io/sbt-web-presentation/#/step-1">slides</a></p>

<h4>&ldquo;Typesafing your blobs with Scala&rdquo; from <a href="https://twitter.com/skaalf">Julien Tournay</a> and <a href="https://twitter.com/mandubian/">Pascal Voitot</a></h4>

<p>Julien and Pascal show us the new <a href="https://github.com/jto/Play20/tree/new_validation_api/documentation/manual/scalaGuide/main/validation">validation API</a>, unifying the Form and JSON validation.
This new API should appear in Play 2.3.<br/>
<a href="http://jto.github.io/articles/play_new_validation_api/">More info</a><br/>
<a href="https://docs.google.com/presentation/d/1bc4437zIO3dUD0cYoSFDbNjrSErY3soURfE5QUErbgw/pub?start=false&amp;loop=false&amp;delayms=3000#slide=id.g11c889a6e_23">slides</a></p>

<h4>&ldquo;Writing a reactive web app with Scala.js and ReactJS&rdquo; from <a href="https://twitter.com/matthiasnehlsen">Matthias Nehlsen</a></h4>

<p>Matthias, famous for his <a href="http://matthiasnehlsen.com/">blog</a> and his <a href="http://birdwatch.matthiasnehlsen.com/">realtime reactive tweet analysing application</a> talked about the <a href="http://facebook.github.io/react/">ReactJS UI library</a> combined with <a href="http://www.scala-js.org/">ScalaJS</a>.
These two tools can be well combined. ReactJS like immutable data structure, that ScalaJS can provide.</p>

<h4>&ldquo;Play2 and Redis : when simplicity meets productivity&rdquo; from <a href="https://twitter.com/nmartignole">Nicolas Martignole</a></h4>

<p>Nicolas talked about his experience with Redis and Play. This combination is looking very simple and performant.</p>

<h4>&ldquo;Building composable, streaming, testable Play apps&rdquo; from <a href="https://twitter.com/brikis98">Yevgeniy Brikman</a></h4>

<p>The &ldquo;Jim&rdquo; from LinkedIn talked about how to compose web pages together, using the <a href="https://www.facebook.com/note.php?note_id=389414033919">Facebook&rsquo;s BigPipe concept</a>.
Very interesting way to decompose a web site into small web components.<br/>
<a href="http://de.slideshare.net/brikis98/composable-and-streamable-play-apps">slides</a></p>

<h4>&ldquo;Play is for Performance&rdquo; from <a href="https://twitter.com/jroper">James Roper</a>, tech lead for Play! framework</h4>

<p>Very interesting talk about how to optimize (or not) an asynchronous Play! application.<br/>
<a href="https://github.com/jroper/play-is-for-performance">slides as Play! application</a> (simply check it out and start the Play! application, it is very impressive)</p>

<h4>&ldquo;Making the case for Play&rdquo; from <a href="https://twitter.com/ajevans85">Adam Evans</a> and <a href="https://twitter.com/asherglynn">Asher Glynn</a>, BBC</h4>

<p>Adam and Asher talked about pushing change within an organization like the BBC, how they introduced the Play Framework!<br/>
<a href="http://pt.slideshare.net/ajevans/making-the-30191542">slides</a></p>

<h4><a href="https://twitter.com/grantklopper">Grant Klopper</a>, Software engineer at The Guardian.</h4>

<p>Grant made a change during the talk and push it into production, very impressive.</p>

<h4><a href="https://twitter.com/tobnee">Tobias Neef</a></h4>

<p>Tobias talk about action composition and filter in Play, when to use the first ones and when to use the others.</p>

<h4>&ldquo;Async: Reacting instead of waiting for better times&rdquo; from <a href="https://twitter.com/apnylle">Johan Andrén</a></h4>

<p>Johan talk about asynchronous programming and how it works with Play. A very good introduction!<br/>
<a href="http://de.slideshare.net/johanandren/async-react-dont-wait-ping-conf">slides</a></p>

<hr/>


<p>My talk was about &ldquo;Structure your Play application with the cake pattern (and test it)&rdquo;</p>

<p>I talked about how to organize a Play! application written in Scala into components with the cake pattern.
The main goal of these components is to encaspulate and expose services only to others components, and to declare dependencies if needed.</p>

<p>As a side effect, the cake pattern allows to inject dependencies at compile time.
A particularity of this &ldquo;dependency injection&rdquo; mechanism is that it does not need any container like Spring or Guice at runtime.</p>

<p><a href="http://www.ustream.tv/recorded/42775808">Video of my talk &ldquo;Structure your Play application with the cake pattern (and test it)&rdquo;</a><br/>
<a href="http://de.slideshare.net/yann_s/play-withcake-export2">slides</a></p>

<p>I had great feedbacks, like these ones:<br/>
<blockquote><p>Leanovate Software Engineer Yann Simon gives the best presentation on the cake pattern I’ve ever seen.</p><footer><strong>Gilt</strong> <cite><a href="http://tech.gilt.com/post/74733533436/a-few-things-about-ping-a-play-framework-conference">http://tech.gilt.com/post/74733533436/a-few-things-about-ping-a-play-framework-conference</a></cite></footer></blockquote>
<blockquote><p>it was great that Yann pointed out the disadvantages as well every step along the way and made it clear how far it’s worth going in various cases.</p><footer><strong>Csaba Palfi</strong> <cite><a href="http://csaba.palfi.me/ping-conf-day-1/">http://csaba.palfi.me/ping-conf-day-1/</a></cite></footer></blockquote>
<blockquote><p>Currently talking, is astounding the audience with live baking an application, slam dunk videos feat. Sulley - of Monsters fame - and hand drawn presentation slides!</p><footer><strong>kinja</strong> <cite><a href="http://pingconference.kinja.com/yann-simon-1502530900">http://pingconference.kinja.com/yann-simon-1502530900</a></cite></footer></blockquote>
<blockquote><p>All this was presented using funny monster videos and a French-German accent.</p><footer><strong>Marius Soutier</strong> <cite><a href="http://www.mariussoutier.com/blog/2014/01/20/ping-conference-play-edition-day-1/">http://www.mariussoutier.com/blog/2014/01/20/ping-conference-play-edition-day-1/</a></cite></footer></blockquote></p>

<blockquote class="twitter-tweet" lang="en"><p>the infamous Totoro-defense! <a href="https://twitter.com/search?q=%23pingconf&amp;src=hash">#pingconf</a> <a href="http://t.co/EnJhauj8tw">pic.twitter.com/EnJhauj8tw</a></p>&mdash; serif (@_serif) <a href="https://twitter.com/_serif/statuses/423793818857930752">January 16, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>Thanks everybody!</p>

<hr/>


<p>Some people saw that I was using my phone to controll the slideshow during the talk and asked me how I did that.
I was simply using <a href="https://www.libreoffice.org/">LibreOffice Impress</a> for my slides. I controlled the slideshow with <a href="https://play.google.com/store/apps/details?id=org.libreoffice.impressremote&amp;hl=en">Impress Remote app</a> installed on my phone.
It works very well. The app displays the duration of your talk, the current, previous and next slide.</p>
]]></content>
  </entry>
  
</feed>
